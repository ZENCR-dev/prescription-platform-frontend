**文档版本：** 11
**日期：** [当前日期]
**负责人：** [你的名字] (产品经理)
**关联文档：** MVP1.0 PRD and SOP v1.3

### **1. 引言**

#### **1.1 项目目标**

本 PRD v1.1 定义了新西兰中医处方平台 MVP 1.0 阶段的功能需求，并**为后端开发团队提供产品层面的参照和验证标准**。核心目标是将已完成的纯前端原型 (MVP 0.8) 对接一个稳定、可靠且**完全符合既定业务逻辑**的后端系统，为上线进行真实市场验证做好准备。

我们将聚焦于为新西兰中医师提供一个现代化的电子处方及草药调配协作平台，**解决其自建药房成本高、运营复杂的痛点**，同时通过引入**高效的处方模板和历史管理功能**，显著提升其工作效率和用户粘性。

#### **1.2 核心业务逻辑 (最终决策)**

平台采用 **“诊所预付/信用额度”** 模式，确保平台财务风险可控。核心流程如下：

1.  **医生开方与支付：** 医生使用平台开具处方，系统从其关联诊所的预付/信用账户中**实时、事务性地扣除**订单成本 (B)，生成**有效凭证** (二维码)。
2.  **凭证交付：** 医生通过打印/邮件等方式将凭证交付给患者。
3.  **药房履约与验证：** 患者持凭证到合作药房。药房扫码后，平台后端通过 **P1-P2 API** 验证订单真实性。药房完成配药并上传履约照片。
4.  **审核与结算：** 平台管理员**手动审核**履约凭证。审核通过后，系统**自动触发**与药房的结算流程 (支付 C)。

### **2. 用户角色与权限**

*   **核心用户角色：** 医生 (Doctor), 药房操作员 (Pharmacy Operator), 平台管理员 (Admin)。
*   **未来用户角色：** 患者 (Patient)。
*   **权限模型：** 严格遵循**SOP v1.3 附录 11.4**中定义的 **用户角色权限矩阵**，后端需实现相应的 RBAC (Role-Based Access Control) 机制。

### **3. 功能需求 (MVP 1.0)**

#### **3.1 核心业务闭环 (优先级 P0)**

| 功能模块 | 功能点 | 用户故事 (As a... I want to... so that...) | 后端支持需求 (MVP 1.0) |
| :--- | :--- | :--- | :--- |
| **医生开方** | 1. 创建处方 | 作为一名**医生**，我希望能快速搜索药品、设置剂量和帖数、添加医嘱，以高效地创建一张完整的电子处方。 | - 提供药品目录查询 API (支持模糊搜索、分页)。<br>- 提供创建处方/订单的 API，处理处方项、患者信息、备注等。 |
| | 2. 诊所账户支付 | 作为一名**医生**，我希望在提交处方时，系统能自动从我诊所的预付账户扣款，并立即告知我结果，以便我能确认处方是否生效。 | - 实现**诊所信用/预付账户体系** (CRUD)。<br>- 实现订单创建时**实时、可靠地扣除账户额度/预付款**的事务性操作。<br>- 扣款失败时返回明确的错误信息。 |
| | 3. 生成有效凭证 | 作为一名**医生**，我希望支付成功后能立即获得一个包含二维码的、清晰的电子凭证，方便我打印或发送给患者。 | - 订单支付成功后，后端生成包含订单核心信息的 **QR 码数据**。<br>- 提供 API 供前端获取订单详情和 QR 码数据。 |
| **药房履约** | 4. 验证订单 | 作为一名**药房操作员**，我希望在扫描患者的二维码后，系统能立即验证订单的真伪和核心内容，以避免处理无效或错误的订单。 | - 提供 **P1-P2 订单信息验证 API**，接收订单号，返回订单的真实 SKU、数量等核心信息。 |
| | 5. 提交履约凭证 | 作为一名**药房操作员**，我希望在配药完成后，能方便地上传一张履约照片作为凭证，以完成我的履约流程。 | - 提供**文件上传服务** (通过签名 URL 方式)。<br>- 提供 API 允许药房提交履约凭证（包含文件 ID 和备注），并更新订单状态为 `PENDING_REVIEW`。 |
| **管理员审核** | 6. 手动审核 | 作为一名**管理员**，我希望能在一个清晰的界面上查看药房提交的履约凭证（包括照片），并进行“通过”或“拒绝”的操作，以确保履约质量。 | - 提供查询 `PENDING_REVIEW` 状态订单的 API。<br>- 提供审核履约凭证的 API，接收审核结果并更新订单状态。 |
| **平台结算** | 7. 自动触发结算 | 作为一名**管理员**，我希望在我批准履约凭证后，系统能自动生成与药房的结算记录，减少我的人工财务操作。 | - **自动化业务逻辑**：在订单状态变为 `FULFILLED` 时，**自动创建**一条待支付的结算记录。 |
| | 8. 标记支付与通知 | 作为一名**管理员**，我希望在完成对药房的线下转账后，能在后台将结算记录标记为“已支付”，并自动通知药房。 | - 提供 API 更新结算记录状态。<br>- **自动化业务逻辑**：在结算记录状态变为 `PAID` 时，**自动触发**邮件通知给药房。 |

#### **3.2 关键支撑功能 (基于 MVP 0.8 原型)**

| 功能模块 | 功能点 | 用户故事 | 后端支持需求 (MVP 1.0) | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| **用户与认证** | 9. 统一认证与授权 | 作为一名**平台用户**，我希望能通过统一的登录入口访问为我授权的功能，并确保我的数据安全。 | - 实现统一的 JWT 签发、校验、刷新机制 (封装 Supabase Auth)。<br>- 实现基于角色的 API 权限控制 (RBAC)。 | P0 |
| **医师工作站** | 10. **处方模板管理** | 作为一名**医生**，我希望能创建、编辑、复制和使用我的常用处方模板，以大幅缩短开具重复处方的时间。 | - 提供处方模板的 **CRUD API**。<br>- 支持按医生 ID 查询其个人模板列表。 | P1 |
| | 11. **处方历史查看** | 作为一名**医生**，我希望能方便地查看我开具过的所有处方历史记录，并按状态或患者进行筛选，以便于复诊和跟踪。 | - 提供查询医生个人处方历史的 API (支持分页、按状态/关键词筛选)。 | P1 |
| **患者体验** | 12. 药房查找 | 作为一名**患者**（或代其操作的医生），我希望能在一个公开页面上，根据我的位置查找附近有哪些合作药房，并了解它们大致的药品供应能力。 | - 提供查询药房列表的公开 API (支持地理位置查询)。<br>- 后端需维护药房的供应能力数据（非实时库存），并在 API 中支持按药品 SKU 进行筛选。 | P1 |
| **市场推广** | 13. 医生推荐机制 | 作为一名**医生**，我希望能通过分享我的推荐码邀请同行加入，并获得平台奖励，帮助平台成长的同时也让我获益。 | - 后端需支持推荐码的生成、验证和关联逻辑。<br>- 提供 API 查询推荐关系和统计数据。 | P2 |
| **管理后台** | 14. 基础数据管理 | 作为一名**管理员**，我需要能查看平台的用户、药品、药房列表，以进行日常的运营监控。 | - 提供用户、药品、药房列表的基础查询 API (支持分页、筛选、排序)。 | P2 |
| | 15. 基础报表 | 作为一名**管理员**，我希望能在一个仪表盘上看到平台最核心的运营数据（如活跃医生数、订单量、GTV），以便快速了解业务健康状况。 | - 提供计算和查询核心 KPI 的 API。 | P3 |

#### **3.3 订单状态机 (最终版)**

后端 `Order Service` 中的状态机必须严格遵循**SOP v1.3 附录 11.8** 中定义的统一订单状态机，包括其状态定义、流转逻辑和业务规则。任何状态的变更都必须经过严格的校验。 
```typescript
//11.8. 统一订单状态机定义 (@MVP1.0PRDandSOPv1.3Final)  
// ✅ 修正后的状态机定义
enum OrderStatus {
  DRAFT = 'DRAFT',// 草稿状态，医生创建但未提交支付
  PAYMENT_FAILED = 'PAYMENT_FAILED',  // 支付失败（如余额不足、账户冻结等）
  PAID = 'PAID',  // 已支付成功（诊所账户已扣款），凭证已生成，等待药房履约
  PENDING_REVIEW = 'PENDING_REVIEW',  // 药房已提交履约凭证，等待平台管理员审核
  REJECTED = 'REJECTED',     // 管理员审核拒绝履约凭证，等待药房重新提交或进一步处理
  FULFILLED = 'FULFILLED',            // 管理员审核通过，订单履约完成，触发与药房的结算
  CANCELLED = 'CANCELLED',            // 订单在履约前被取消（需要触发退款）
  EXPIRED = 'EXPIRED'                 // 凭证超时未被履约（需要触发退款）
},
// ✅ 状态转换规则（必须在后端代码中严格执行）
const VALID_TRANSITIONS = {
  DRAFT: ['PAYMENT_FAILED', 'PAID', 'CANCELLED'],
  PAYMENT_FAILED: ['PAID', 'CANCELLED'], // 允许对失败的订单重新发起支付
  PAID: ['PENDING_REVIEW', 'CANCELLED', 'EXPIRED'],
  PENDING_REVIEW: ['REJECTED', 'FULFILLED'],
  REJECTED: ['PENDING_REVIEW', 'CANCELLED'], // 允许被拒绝的履约凭证重新提交
  FULFILLED: [], // 终态，不可变更
  CANCELLED: [], // 终态，不可变更
  EXPIRED: []    // 终态，不可变更
},
// ✅ 退款处理规则
const REFUND_RULES = {
  CANCELLED: 'FULL_REFUND',    // 订单被取消，必须全额退款到诊所账户
  EXPIRED: 'FULL_REFUND',      // 订单过期，必须全额退款到诊所账户
  REJECTED: 'NO_REFUND'        // 履约被拒，不触发退款，等待重新履约
};
```
### **4. MVP 1.0 开发里程碑与产品校准点**

**目的：** 本节旨在将后端的开发计划（Phase 1）与产品层面的关键节点进行绑定，设立明确的沟通和评审机制，确保开发过程不偏离产品目标。

|   |   |   |   |   |
|---|---|---|---|---|
|开发阶段 (来自SOP)|时间节点|产品里程碑|**核心小组评审/磋商点 (Checkpoints)**|负责人准备内容|
|**Task 1 & 2**|**Week 2 末**|**核心基础设施与认证地基完成**|**Checkpoint 1: 架构与认证方案评审**<br>1. 评审最终的数据库 Schema 是否完全支持所有业务实体和关系。<br>2. 评审核心认证 API (/auth/login, /auth/me 等) 的 OpenAPI 规范，确保其满足前端对接需求。<br>3. 确认全局错误处理和日志记录机制符合产品运营需求。|**后端 Leader:** 提供 Prisma Schema 终稿、核心认证 API 的 OpenAPI 规范文档。<br>**产品经理:** 准备用户故事和验收标准，验证数据模型。<br>**前端 Leader:** 准备前端适配需求清单。|
|**Task 3 & 4**|**Week 4 末**|**核心数据服务与账户体系就绪**|**Checkpoint 2: 诊所账户与数据服务评审**<br>1. 评审诊所账户 (Clinic Account) 服务的 API，特别是余额查询、状态管理等。<br>2. 评审药品查询 API 是否满足前端搜索和展示需求。<br>3. 确认审计日志记录了关键的账户操作。|**后端 Leader:** 提供诊所账户和药品服务的 API 规范和 Demo。<br>**产品经理:** 验证账户管理流程是否符合业务风控要求。|
|**Task 5 & 6**|**Week 6 末**|**核心交易与支付逻辑完成 (重点)**|**Checkpoint 3: 核心支付流程端到端评审 (⭐⭐⭐)**<br>1. **重点评审：** 演示并验证**原子性扣款**逻辑，包括并发场景和余额不足场景。<br>2. 验证订单状态是否能根据支付结果正确流转到 PAID 或 PAYMENT_FAILED。<br>3. 确认 account_transactions 表准确记录了每一笔资金流水。<br>4. 评审订单创建 API 的幂等性实现。|**后端 Leader:** 准备**可演示的、包含压力测试结果的**核心支付流程 Demo，提供相关代码和数据库日志。<br>**产品经理:** 准备详细的支付场景测试用例（正常、异常、并发）。<br>**架构师:** 评审事务、并发控制和幂等性实现方案。|
|**Task 7 & 8**|**Week 8 末**|**完整业务流程闭环，准备联调**|**Checkpoint 4: MVP 1.0 后端功能完整性验收**<br>1. 演示完整的核心业务流程：从医生开方到药房履约、管理员审核、平台结算的全过程。<br>2. 验证文件上传（签名 URL）和邮件通知功能是否按预期工作。<br>3. 最终确认所有 P0 和 P1 优先级的 API 已准备就绪，可以交付前端进行全面联调。|**后端 Leader:** 提供 MVP 1.0 后端所有核心功能的集成 Demo 和最终版 OpenAPI 规范。<br>**核心小组全体:** 进行最终的功能验收，并批准进入前后端联调阶段。|
### **5. 非功能性需求**

| 类别 | 需求描述 |
| :--- | :--- |
| **性能** | - 核心 API (如订单创建、药品搜索) 响应时间应在 500ms 以内。<br>- 平台需能支持初期 100 名医生同时在线操作的并发量。 |
| **安全** | - 遵循 Security by Design 原则，实现用户认证、授权 (RBAC) 和数据校验。<br>- 对敏感数据（如密码、API密钥）进行加密存储。<br>- 防止常见的 Web 攻击（XSS, CSRF, SQL注入等）。 |
| **可靠性** | - 系统核心业务流程可用性需达到 99.9%。<br>- 数据库和文件存储需有可靠的备份和恢复机制。 |
| **可维护性** | - 后端服务需模块化，遵循清晰的设计模式。<br>- 提供完善的 API 文档 (OpenAPI/Swagger)。<br>- 关键业务逻辑需有单元测试和集成测试覆盖。 |
| **合规性** | - 遵循新西兰数据隐私法规 (Privacy Act 2020)。<br>- 在引入真实数据和交易前，完成法律与财税咨询。 |

### **6. 成功指标 (KPIs)**

MVP 1.0 上线后，我们将重点追踪以下核心指标，以评估产品成功与否：

| KPI 分类 | 指标名称 | 衡量目标 |
| :--- | :--- | :--- |
| **用户增长与活跃度** | 月活跃医师 (MAU) | 核心用户粘性与产品价值体现。 |
| | 医师留存率 (Doctor Retention) | 产品对现有用户的持续吸引力。 |
| **业务与履约效率** | 月总订单数 | 平台业务规模。 |
| | 订单履约率 (Order Fulfillment Rate) | 核心业务流程的顺畅度。 |
| **财务表现** | 月度总交易额 (GTV - 基于B价) | 平台业务规模。 |
| | 月度毛利总额 (Gross Profit) | 平台核心盈利能力。 |

---

**结论：**

这份 **PRD v1.1** 在继承 v1.0 核心需求的基础上，增加了**开发过程中的产品校准机制**。通过设立与后端开发计划同步的四大里程碑和评审点，我们可以确保技术实现始终服务于产品价值，及时发现并纠正偏差，从而最大化 MVP 1.0 的成功概率。

我将与后端 Leader 紧密合作，跟进每个阶段的开发进度，并组织核心小组在每个 Checkpoint 进行高效的评审和决策。