# MVP 2.0 开发指导文档体系总纲

## 📋 文档概述

本文档是MVP 2.0开发的总纲指导文件，采用螺旋式配对开发模式，将MVP 1.1需求分解为8个相互关联的开发模块。遵循测试导向原则，为开发团队提供功能目标和测试标准，赋予充分的技术实现自主权。

**文档版本**：3.0  
**创建日期**：2025年1月9日  
**最后更新**：2025年7月12日  
**项目**：新西兰中医药电子处方平台 MVP 2.0  
**定位**：开发指导体系总纲 + 平台业务流程与价值主张

---

## 🏗️ 平台业务流程与价值主张 (2025年7月12日新增)

### 💰 核心商业模式：B2B2C差价盈利平台

我们构建的是一个**新西兰中医药电子处方平台**，通过连接医师、药房和患者，实现以下核心价值：

#### 🔄 完整业务流程设计
```
医师开处方 → 计算总价(net_price) → 医师账户支付 → 生成QR码 
    ↓
药房扫码 → 配药履约 → 上传凭证 → 自动生成PO → 平台审核 → 药房收款
    ↓
平台收益 = net_price(医师支付) - PO_amount(药房成本) = 差价利润
```

#### 💎 核心价值主张

**对医师的价值**：
- **便捷处方管理**: 数字化处方创建、历史查询、状态跟踪
- **透明计费系统**: 预先显示总价，支持余额和Stripe支付
- **合规保障**: 隐私保护设计，无患者信息存储风险
- **实时通知**: WebSocket推送处方状态变更和支付结果

**对药房的价值**：  
- **标准化流程**: 扫码验证→配药→履约→自动结算的完整闭环
- **收入保障**: PO机制确保及时收款，减少坏账风险
- **库存管理**: 价目表版本控制，实时库存状态更新
- **提现便利**: 批量PO提现，自动生成Invoice

**对患者的价值**：
- **隐私保护**: 完全匿名化处理，无个人信息泄露
- **便民服务**: 药房地图导航，营业时间查询
- **透明反馈**: 匿名评价系统，改善服务质量

**对平台的价值**：
- **可持续盈利**: 医师支付与药房成本间的差价收益模式
- **风险控制**: 预付费模式，减少坏账和欺诈风险  
- **数据价值**: 处方趋势、药品使用数据（匿名化）分析
- **网络效应**: 连接更多医师和药房，提升平台价值

#### 📊 关键业务数据结构

**处方核心实体**（隐私合规版）：
```typescript
interface Prescription {
  id: string;                    // 系统内部ID
  prescriptionId: string;        // 业务ID：RX-YYYYMMDD-序号
  doctorId: string;             // 医师ID
  copies: number;               // 帖数 (1-30范围)
  grossWeight: number;          // 总克重
  netPrice: number;             // 总价格（医师支付）
  isHighValue: boolean;         // $500+ 自动标记
  highValueWarning?: string;    // 前端警告信息
  status: 'DRAFT' | 'PAID' | 'FULFILLED' | 'COMPLETED';
  medicines: PrescriptionMedicine[];
  // 注意：无患者个人信息字段（隐私合规）
}
```

**支付流向监控**：
```typescript
interface PaymentFlow {
  // 1. 医师支付阶段
  practitionerPayment: {
    source: "PractitionerAccount.balance",
    amount: "Prescription.netPrice", 
    trigger: "POST /api/v1/prescriptions/:id/pay-with-balance"
  },
  
  // 2. 平台收益计算
  platformProfit: {
    formula: "netPrice - PO_totalAmount",
    margin: "通常15-30%差价",
    riskControl: "预付费模式，无坏账风险"
  },
  
  // 3. 药房结算阶段  
  pharmacySettlement: {
    trigger: "PO审核通过",
    amount: "PurchaseOrder.totalAmount",
    destination: "PharmacyAccount.balance"
  }
}
```

#### 🔍 状态监控与事件驱动系统

**实时状态跟踪**：
- **WebSocket事件**: `connection_status`, `prescription.paid`, `po.approved`, `balance.updated`
- **审计日志**: 完整的状态变更记录和资金流水
- **高价值处方警告**: 自动触发$500+处方的前端警告机制

---

## 🎯 核心开发原则

### 螺旋式配对开发
- **开发顺序**：后端API先行 → 前端实现跟进 → 联调验证
- **并行推进**：四端（医师、药房、管理员、患者）同步开展
- **迭代验证**：每个功能点完成即验证，不等待全部完成

### 测试导向开发（TDD）
- **测试优先**：先定义验收标准，再进行开发
- **全面覆盖**：单元测试、集成测试、E2E测试
- **持续验证**：每次代码提交必须通过所有测试

### 技术自主权
- **框架选择**：团队可选择最佳技术栈
- **实现方式**：不限定具体实现，以通过测试为准
- **创新鼓励**：支持采用新技术提升效率

---

## 🔄 螺旋式开发时间线

### 第一螺旋（第1-3周）
**后端开发**：
- MVP 2.1：医师端核心API（处方CRUD、历史查询、支付集成）
- MVP 2.3：药房端核心API（处方扫码、履约上传、PO生成）
- MVP 2.5：管理员端核心API（全局查询、审核功能、余额管理）
- MVP 2.7：患者端基础API（药房查询、匿名反馈）

### 第二螺旋（第3-5周）
**前端开发与联调**：
- MVP 2.2：医师端前端（处方创建界面、支付流程、Stripe充值）
- MVP 2.4：药房端前端（扫码功能、拍照上传、提现管理）
- MVP 2.6：管理员端前端（审核界面、转账操作）
- MVP 2.8：患者端前端（地图导航、评价系统）

### 第三螺旋（第5-7周）
**功能增强**：
- 跨端状态同步优化
- 实时通知机制
- 性能优化
- 安全加固

### 第四螺旋（第7-8周）
**集成测试**：
- 端到端业务流程验证
- 压力测试
- 用户验收测试
- 生产部署准备

---

## 📊 MVP2.1 医师端后端实施摘要

### 开发现状
基于详细的代码分析，项目已有坚实的技术基础：
- ✅ **已完成**：认证系统、用户管理、支付引擎（Stripe集成）、WebSocket通信、数据库事务管理
- ⚠️ **待完成**：医师账户API端点、处方业务逻辑增强、支付流程集成、公共API实现

### 测试驱动开发策略
严格遵循TDD原则，每个功能开发流程：
1. **编写测试** → 2. **最小实现** → 3. **重构优化**

测试覆盖要求：
- 单元测试：>85%
- API端点：100%
- 核心业务：>90%

### 四周开发计划
**第1周 - 医师账户API**
- 完善PractitionerAccountController（4个API端点）
- 集成现有PractitionerAccountService
- Stripe充值功能集成

**第2周 - 处方管理增强**
- 增强PrescriptionService业务逻辑
- 实现处方CRUD和QR码生成
- 集成事件驱动架构

**第3周 - 支付系统集成**
- 创建PrescriptionPaymentService
- 实现余额支付和Stripe支付
- WebSocket实时通知

**第4周 - 公共API与优化**
- 公共药品查询API
- 性能优化和安全加固
- 部署准备

### 关键技术决策
- **充分利用现有模块**：避免重复开发，最大化投资回报
- **事务一致性**：使用Prisma事务和乐观锁
- **实时通信**：利用现有OrchestrationService
- **API版本控制**：统一使用/api/v1/

### 质量保证措施
- GitHub Actions CI/CD流水线
- 自动化测试和代码覆盖率检查
- OWASP安全扫描
- 性能基准测试（API响应<200ms）

---

## 📊 功能场景技术规范

### 医师端核心功能

#### 1. 处方创建与持久化
**业务描述**：医师创建处方并保存到数据库  
**技术要求**：
- RESTful API：`POST /api/v1/prescriptions`
- 数据验证：药品库存、价格实时校验
- 幂等性保证：防止重复提交
- 响应时间：< 500ms

**测试要求**：
- 正常创建流程测试
- 异常数据处理测试
- 并发创建测试
- 数据完整性验证

#### 2. 历史处方检索
**业务描述**：按日期范围查询历史处方及状态  
**技术要求**：
- RESTful API：`GET /api/v1/prescriptions?startDate=&endDate=&status=`
- 分页支持：默认20条/页
- 排序选项：创建时间、金额、状态
- 缓存策略：合理使用缓存提升性能

**测试要求**：
- 多条件组合查询测试
- 分页边界测试
- 性能测试（1000+记录）
- 权限隔离测试

#### 3. 余额支付与状态管理
**业务描述**：发起支付并更新处方状态  
**技术要求**：
- 支付API：`POST /api/v1/payments/balance`
- 状态流转：created → paid → dispensed → completed
- 事务保证：支付与状态更新的原子性
- 事件通知：WebSocket或SSE推送状态变更

**测试要求**：
- 支付成功/失败场景
- 余额不足处理
- 状态流转完整性
- 并发支付测试

#### 4. Stripe充值集成
**业务描述**：通过Stripe为账户充值  
**技术要求**：
- Stripe SDK集成
- 支付意图创建：`POST /api/v1/payments/stripe/intent`
- Webhook处理：异步确认支付结果
- 安全要求：PCI DSS合规

**测试要求**：
- 支付流程完整性测试
- Webhook幂等性测试
- 错误恢复测试
- 安全漏洞扫描

### 药房端核心功能

#### 1. 处方扫码定位
**业务描述**：扫描二维码获取处方信息  
**技术要求**：
- 扫码API：`POST /api/v1/prescriptions/scan`
- 验证机制：处方有效性、支付状态
- 响应内容：处方详情、药品清单
- 错误处理：无效码、过期处方

**测试要求**：
- 有效二维码识别
- 无效数据处理
- 权限验证测试
- 响应时间测试

#### 2. 履约凭证上传
**业务描述**：上传药包和电子秤照片  
**技术要求**：
- 上传API：`POST /api/v1/fulfillments`
- 图片要求：最大5MB，支持JPEG/PNG
- AI识别：集成OCR识别重量（可选）
- 状态更新：paid → dispensed

**测试要求**：
- 文件上传完整性
- 图片格式验证
- 大文件处理
- 并发上传测试

#### 3. PO自动生成
**业务描述**：根据价目表生成采购订单  
**技术要求**：
- 触发机制：履约凭证上传成功后
- 价格计算：处方药品 × 数量 × 价目表价格
- 数据关联：PO与处方的一对一绑定
- 审核队列：自动加入待审核列表

**测试要求**：
- 价格计算准确性
- PO生成完整性
- 异常处理测试
- 数据一致性验证

#### 4. 提现请求管理
**业务描述**：批量选择已审核处方发起提现  
**技术要求**：
- 提现API：`POST /api/v1/withdrawals`
- 批量操作：支持多选处方
- Invoice生成：汇总金额和明细
- 状态追踪：申请 → 处理中 → 完成

**测试要求**：
- 批量操作测试
- 金额计算验证
- 状态流转测试
- 并发请求处理

### 管理员端核心功能

#### 1. 全局数据查询
**业务描述**：查看所有处方、PO、Invoice  
**技术要求**：
- 统一查询接口：支持多种资源类型
- 高级筛选：多条件组合查询
- 数据导出：CSV/Excel格式
- 实时统计：仪表板数据

**测试要求**：
- 大数据量查询性能
- 筛选条件组合测试
- 导出功能完整性
- 权限控制验证

#### 2. 审核与状态管理
**业务描述**：审核PO并更新状态  
**技术要求**：
- 审核API：`PATCH /api/v1/purchase-orders/:id/approve`
- 批量审核：支持批量操作
- 审核日志：记录操作历史
- 通知机制：审核结果实时通知

**测试要求**：
- 审核流程完整性
- 批量操作原子性
- 日志记录准确性
- 通知送达验证

#### 3. 财务操作执行
**业务描述**：执行余额充值和转账  
**技术要求**：
- 余额操作：原子性事务保证
- 转账API：`POST /api/v1/transfers`
- 对账机制：交易记录完整可查
- 安全控制：二次验证、操作限额

**测试要求**：
- 事务一致性测试
- 并发操作测试
- 安全控制验证
- 对账准确性测试

### 患者端核心功能

#### 1. 药房地理位置服务
**业务描述**：查找附近药房并导航  
**技术要求**：
- 位置API：`GET /api/v1/pharmacies/nearby?lat=&lng=&radius=`
- 地图集成：支持主流地图服务
- 实时状态：营业时间、库存情况
- 路线规划：最短路径计算

**测试要求**：
- 位置计算准确性
- 性能响应测试
- 边界情况处理
- 地图服务容错

#### 2. 匿名评价系统
**业务描述**：服务和疗效评价，每日限一次  
**技术要求**：
- 评价API：`POST /api/v1/feedbacks`
- 频率限制：基于设备ID/IP的限制
- 数据脱敏：不关联个人信息
- 统计分析：评价数据聚合

**测试要求**：
- 频率限制验证
- 匿名性保证
- 数据完整性
- 统计准确性

---

## 🧪 测试标准体系

### 单元测试要求
- 核心业务逻辑覆盖率 > 80%
- 边界条件100%覆盖
- 异常处理100%覆盖

### 集成测试要求
- API端点100%覆盖
- 数据库事务完整性验证
- 第三方服务集成测试

### E2E测试要求
- 完整业务流程验证
- 跨端协作场景测试
- 用户操作路径覆盖

### 性能测试要求
- API响应时间P95 < 300ms
- 并发用户数 > 1000
- 数据库查询优化验证

### 安全测试要求
- OWASP Top 10扫描
- 认证授权完整性
- 数据加密验证
- SQL注入防护

---

## 📝 开发规范

### API设计规范
- RESTful风格一致性
- 统一错误码体系
- 版本管理策略
- 文档自动生成（Swagger）

### 数据库设计规范
- 表命名规范
- 索引优化策略
- 数据归档方案
- 备份恢复机制

### 代码质量规范
- ESLint/TSLint配置
- 代码评审要求
- Git提交规范
- CI/CD流程

---

## 🚀 交付标准

### 功能交付
- 所有测试用例通过
- API文档完整
- 部署文档齐全

### 性能交付
- 负载测试报告
- 性能优化记录
- 监控告警配置

### 安全交付
- 安全扫描报告
- 渗透测试结果
- 应急预案文档

---

## 📊 成功指标

1. **功能完整性**：100%需求覆盖
2. **系统稳定性**：99.9%可用性
3. **用户满意度**：NPS > 50
4. **团队效率**：按时交付率 > 90%

本总纲为MVP 2.0的指导原则，各子文档将基于此制定具体的开发指导和测试要求。