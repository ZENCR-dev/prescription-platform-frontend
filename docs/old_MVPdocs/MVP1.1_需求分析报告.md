# MVP 1.1 需求分析报告

## 📋 文档概述

本文档对用户提出的MVP 1.1升级需求进行深度分析，识别需求描述中的问题，并基于最佳实践提供批判性建议和技术建议。
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMSCUZAYK+SZ5a8UKiILEVhTnjYrBDIMzI4ueP+gLYO6 info@zencr.org

---

### 🔍 原始需求文档质量评估

### 文档问题分析
**《MVP 1.1后端任务清单》存在以下问题**：

1. **写作风格随性散漫**：缺乏技术规范性，使用非正式语言
2. **详细程度不均匀**：部分需求过于简略，部分过于冗长
3. **技术边界模糊**：缺乏明确的功能边界和约束条件
4. **架构一致性问题**：部分需求与现有后端架构存在冲突

### 建议改进方向
- 采用标准化的需求描述格式
- 明确每个功能的技术边界和约束
- 识别并解决架构冲突
- 建立优先级和依赖关系

---

### 🏗️ 架构层面需求分析与建议

### 1. 前端解耦架构

#### 用户需求描述
> "前端各模块解耦，仅通过友链沟通"

#### 批判性分析
**问题识别**：
- "友链"不是技术术语，表达不准确
- 缺乏对跨应用状态同步机制的考虑
- 未考虑认证和授权的复杂性

#### 最佳实践建议
**推荐方案：微前端架构**
- **域名策略**：使用子域名区分不同应用（doctor.nztcm.co.nz, pharmacy.nztcm.co.nz等）
- **认证机制**：实现基于JWT的单点登录(SSO)，支持跨域token验证
- **通信方式**：通过统一的后端API进行数据交互，避免前端应用间直接通信
- **部署策略**：每个应用独立部署，降低耦合度

**关键技术考虑**：
- 需要解决跨域cookie和session管理
- 统一的错误处理和用户体验
- 共享组件库的版本管理

### 2. 开源项目借鉴策略

#### 用户需求描述
> "充分检索和引用借鉴成熟的开源模块"

#### 批判性分析
**现有描述过于抽象**，缺乏具体的评估标准和集成策略。

#### 最佳实践建议
**建立开源项目评估框架**：
1. **技术评估**：活跃度、文档质量、社区支持
2. **法律评估**：许可证兼容性、商用限制
3. **集成评估**：复杂度、维护成本、技术债务
4. **分级策略**：
   - 直接使用：成熟的UI组件、工具库
   - API集成：第三方服务（支付、地图等）
   - 架构参考：设计模式、最佳实践
   - 概念借鉴：业务逻辑、工作流设计

**功能模块开源项目检索词推荐**：

| 功能模块   | 推荐检索词                                                                              | 技术领域  |
| ------ | ---------------------------------------------------------------------------------- | ----- |
| 文件批量上传 | "bulk file upload", "drag drop upload", "file queue processing"                    | 文件处理  |
| 电子签名   | "embedded signature", "pdf signing", "digital signature widget"                    | 文档签名  |
| 地理位置服务 | "geolocation", "nearby search", "distance calculation", "map integration"          | 地理信息  |
| 图像识别   | "OCR", "image text recognition", "scale reading", "computer vision"                | AI/ML |
| 状态机工作流 | "state machine", "workflow engine", "approval process", "finite state automaton"   | 业务流程  |
| 账户余额系统 | "wallet system", "balance management", "transaction history", "payment processing" | 金融科技  |
| 批量数据导入 | "CSV import", "Excel parser", "data validation", "bulk insert"                     | 数据处理  |
| 二维码生成  | "QR code generator", "barcode", "mobile scanning"                                  | 移动应用  |
| 实时通知   | "websocket", "push notification", "real-time updates"                              | 实时通信  |

---

### 🏥 医师端需求分析与建议

### 1. 非登录用户处方创建功能

#### 用户需求描述
> "仅当用户需要进行进阶操作时要求用户登录"

#### 批判性分析
**功能边界不清晰的问题**：
- "进阶操作"定义模糊
- 未考虑安全风险和滥用防护
- 数据处理策略不明确

#### 最佳实践建议
**功能边界明确化**：
- **允许操作**：药品搜索、处方草稿创建、PDF导出（无价格，无签名）
- **禁止操作**：数据保存、患者信息录入、电子签名、收费功能
- **数据策略**：纯前端处理，不与后端数据库交互，但需要实现日志功能
- **安全控制**：API速率限制（药品搜索仍需调用后端API）、价格信息过滤、防爬虫机制

**技术澄清**：
- **为什么需要API速率限制**：虽然处方创建是纯前端处理，但药品搜索功能仍需要调用后端API获取药品信息，因此需要对搜索API实施速率限制以防止滥用
- **日志功能设计**：记录非登录用户的操作行为（搜索关键词、创建时间、导出次数等），用于产品优化和安全监控，但不关联用户身份信息

**商业逻辑考虑**：
此功能可作为"试用"机制，降低用户使用门槛，但需要平衡免费服务与商业价值。

### 2. 医师账户余额系统

#### 用户需求描述
> "practitioner_role users绑定practitioner_acounts"

#### 批判性分析
**现状评估**：基础功能已存在，需要扩展而非重建。

#### 最佳实践建议
**功能完善建议**：
- **支付集成**：集成新西兰本地支付方式（EFTPOS、银行转账）
- **财务合规**：符合新西兰税务和财务报告要求
- **风险控制**：设置单笔和日累计交易限额
- **用户体验**：实时余额显示、交易历史查询、自动对账

### 3. 电子签名功能

#### 用户需求描述
> "第三方签名服务，商用or开源"

#### 批判性分析
**关键考虑因素被忽略**：
- 新西兰电子签名法规要求
- 医疗行业特殊合规要求
- 成本效益分析

#### 更新的技术选型建议
**平台内整合要求**：
1. **优先考虑合规性**：确保符合新西兰《Electronic Transactions Act》
2. **嵌入式签名方案**：
   - **DocuSign Embedded Signing**：支持iframe嵌入，无需跳转
   - **Adobe Sign Widget**：可嵌入网页的签名组件
   - **HelloSign Embedded**：轻量级嵌入式解决方案
3. **开源嵌入式方案**：
   - **pdf-lib + Signature Pad**：完全自主控制的签名实现
   - **React Signature Canvas**：前端签名组件

**单一场景优化建议**：
由于仅处方创建场景需要签名，建议选择一个最佳方案长期维护：
- **推荐方案**：HelloSign Embedded（成本适中，集成简单，合规性好）
- **备选方案**：pdf-lib + 自建数字证书（完全自主，但需要PKI基础设施）

**最佳实践方案（简化描述）**：

**核心思路**：使用@signpdf开源库实现真正的PDF数字签名，而不是简单的图片签名。

**技术实现**：
- **前端**：医师用React Signature Canvas手写签名，收集签名数据
- **后端**：使用@signpdf库将签名转换为PKCS#7数字签名并嵌入PDF
- **证书**：为每个医师生成个人P12数字证书，安全存储在后端
- **验证**：生成的PDF可被任何PDF阅读器验证签名真实性

**用户体验**：
1. 医师创建处方后，在确认页面手写签名
2. 系统自动将手写签名转换为数字签名并嵌入PDF
3. 导出的PDF包含可验证的数字签名，符合法规要求

**技术优势**：
- 使用成熟开源库（@signpdf + node-forge），开发成本低
- 生成标准PKCS#7签名，符合新西兰电子交易法案
- 签名可被PDF阅读器验证，具有法律效力
- 无需第三方服务费用，完全自主可控

**实施复杂度**：中等，主要工作是集成现有开源库和证书管理，不需要从零开发签名算法。

**后端架构调整需求**：
- **新增模块**：PDF生成和电子签名服务
- **API端点**：处方PDF生成、签名验证、文档下载
- **数据存储**：签名证书、PDF文档、签名验证记录
- **与前端集成**：目前前端的PDF功能需要与后端签名服务集成

**实施优先级**：
1. **Phase 1**：后端PDF生成服务基础架构
2. **Phase 2**：电子签名集成和验证机制
3. **Phase 3**：前后端集成和用户体验优化

**最终技术方案（基于@signpdf库）**：
**真正的PDF数字签名实现**：
- **签名类型**：PKCS#7数字签名，符合PDF标准
- **签名流程**：每次创建处方时，在用户确认完成处方阶段进行数字签名
- **技术实现**：
  - **前端签名收集**：使用React Signature Canvas收集医师手写签名
  - **数字证书生成**：为每个医师生成个人数字证书（P12格式）
  - **PDF数字签名**：使用@signpdf库在PDF中嵌入PKCS#7数字签名
  - **签名验证**：PDF阅读器可以验证签名的真实性、完整性和不可否认性
- **合规性**：满足新西兰电子交易法案的数字签名要求
- **技术栈**：
  - **@signpdf/signpdf**：主要PDF签名库
  - **@signpdf/signer-p12**：P12证书签名器
  - **@signpdf/placeholder-pdf-lib**：PDF签名占位符
  - **pdf-lib**：PDF操作和生成
  - **node-forge**：数字证书生成和管理
  - **React Signature Canvas**：前端签名收集

**数字证书管理策略**：
- **证书生成**：为每个医师生成唯一的自签名证书
- **证书存储**：安全存储在后端，加密保护
- **证书有效期**：设置合理的有效期（如2年）
- **证书更新**：提供证书续期和更新机制

**后端PDF签名服务架构**：
```typescript
// 新增PDF签名模块
src/modules/pdf-signature/
├── controllers/
│   └── pdf-signature.controller.ts
├── services/
│   ├── certificate.service.ts      // 数字证书管理
│   ├── pdf-generation.service.ts   // PDF生成
│   └── digital-signature.service.ts // 数字签名
├── dto/
│   ├── sign-prescription.dto.ts
│   └── certificate-generation.dto.ts
└── pdf-signature.module.ts
```

**API端点设计**：
- `POST /api/certificates/generate` - 为医师生成数字证书
- `POST /api/prescriptions/{id}/sign` - 对处方进行数字签名
- `GET /api/prescriptions/{id}/pdf` - 下载已签名的处方PDF
- `POST /api/signatures/verify` - 验证PDF签名有效性

**实施步骤**：
1. **Phase 1**：集成@signpdf库，建立基础PDF签名功能
2. **Phase 2**：实现数字证书生成和管理系统
3. **Phase 3**：前后端集成，优化用户签名体验
4. **Phase 4**：签名验证和审计功能完善

**成本和复杂度分析**：
- **开发复杂度**：中等（使用成熟的@signpdf库降低复杂度）
- **维护成本**：低（开源库，社区支持良好）
- **合规风险**：低（PKCS#7是标准的数字签名格式）
- **用户体验**：良好（签名过程对用户透明）

### 4. 处方定价模块

#### 用户需求描述
> "处方费，为0-50滑块，医师用户可以在后台自主设置"

#### 批判性分析（已澄清）
**定价策略优化**：
- **市场调研**：0-50 NZD属于新西兰中医服务常见定价范围，医师可独立定价
	- 用户：取消滑块设计，改为用户后台自设默认金额，允许手动输入或加减号按钮修改金额
- **灵活定价**：医师可在创建处方时参考自设默认价格调整服务费金额
- **透明度**：向患者清晰展示价格构成（成本价+处方费）
- **合规性**：确保定价符合新西兰医疗服务定价规定

---

### 🎯 管理员端需求分析与建议

### 1. 安全访问控制

#### 用户需求描述
> "vercel托管的非公开链接，防止被破译误入"

#### 批判性分析
**安全策略过于简单**：
- 仅依赖"隐蔽链接"安全性不足
- 缺乏多层防护机制
- 未考虑内部威胁

#### 更新的安全方案建议
**基于谷歌账号的安全策略**：
1. **认证层**：Google OAuth 2.0认证，限制特定谷歌账号访问
2. **授权层**：基于谷歌账号的白名单机制
3. **会话管理**：短时间会话超时，定期重新认证
4. **审计日志**：记录所有管理员操作和访问记录

**部署建议**：
- 使用项目现有的谷歌账户体系进行访问控制
- 配置后端平台自带的DDoS防护
- 定期安全审计和渗透测试

**安全优势分析**：
- **便利性**：开发团队已使用谷歌账户，无需额外账号管理
- **安全性**：利用谷歌的多因素认证和安全基础设施
- **可控性**：可精确控制哪些谷歌账号有访问权限

### 2. 药品表批量上传

#### 用户需求描述
> "管理员通过前端页面工具批量上传药品信息"

#### 批判性分析
**缺乏具体技术规格**：
- 文件格式和大小限制不明确
- 数据验证规则未定义
- 错误处理机制不清晰

#### 最佳实践建议
**技术规格建议**：
- **文件支持**：Excel (.xlsx)主要，CSV (.csv)备用
- **容量限制**：文件10MB，记录10,000条
- **处理方式**：异步队列处理，避免阻塞
- **数据验证**：必需字段检查、格式验证、重复检测
- **用户体验**：进度显示、详细错误报告、部分成功处理

### 3. 履约凭证审核系统

#### 用户需求描述
> "审核通过后自动向药房账户余额按凭证金额转账"

#### 批判性分析（已澄清）
**自动化财务操作风险**：
- MVP1.1阶段保留自动确认功能设计，但所有凭证均需人工审核
- 需要考虑审核错误的后果和补救机制
- 金额计算规则：对应处方所含药物及数量在平台和药房商定的价目表上的价格总和

#### 审核错误处理方案建议
**方案1：预防性审核机制**
- **优点**：错误率低，审核质量高
- **缺点**：审核时间长，人力成本高
- **实施**：双重审核、审核培训、标准化检查清单

**方案2：事后纠错机制**
- **优点**：审核效率高，快速处理
- **缺点**：可能产生错误转账，需要补偿机制
- **实施**：单次审核+错误撤销功能+补偿转账

**推荐混合方案**：
- 小额凭证（<$100）：单次审核+事后纠错
- 大额凭证（≥$100）：双重审核+预防机制

---

### 🏪 药房端需求分析与建议

### 1. 履约凭证提交系统

#### 用户需求描述
> "上传包装好的中药照片作为履约证据"

#### 批判性分析
**证据标准不够明确**：
- 什么构成有效的履约证据
- 照片质量和内容要求
- 审核标准的一致性

#### 更新的证据标准化建议
**履约照片要求**：
- **核心要求**：全部处方药品在同一电子秤上的总重量显示
- **重量验证**：与系统内该处方所含药品的全部克重符合，误差为正负5%
- **必需信息**：清晰的克量数显（通过扫码预填处方单号、药房登录确认身份、上传时间即为包装日期）
- **质量控制**：AI自动识别电子秤/中药包装和克重数显并获取克重与数据库字段比对、人工抽检
- **标准化流程**：提供拍照指导、模板参考

**AI图像识别技术方案**：
- **OCR技术**：识别电子秤数字显示
- **物体检测**：识别中药包装和电子秤
- **数据验证**：提取重量数据与数据库比对
- **技术选型**：
  - 云端方案：Google Vision API、AWS Rekognition
  - 开源方案：Tesseract OCR + OpenCV
  - 专业方案：针对电子秤数显训练的自定义模型

**AI图像识别技术方案（已澄清）**：
**低成本开源/API方案**：
- **首选方案**：Tesseract OCR + OpenCV（开源，无API调用费用）
- **备选方案**：Google Vision API（按使用量付费，月免费额度1000次）
- **技术实现**：
  - 图像预处理：增强电子秤数显区域对比度
  - OCR识别：提取数字显示内容
  - 数据验证：正则表达式验证重量格式
- **无微调预算限制**：使用现有训练模型，通过图像预处理优化识别准确率

**药品克重比对机制（已澄清）**：
**数据源对比**：
1. **处方理论重量**：创建处方时自动计算
   - 计算公式：Σ(每种药品克重 × 帖数)
   - 数据来源：药品基础信息表中的单位重量
   - 存储位置：处方记录的总重量字段（新增字段）

2. **药房实际重量**：履约照片AI识别获取
   - 数据来源：电子秤数显识别结果
   - 验证机制：与处方理论重量比对
   - 误差范围：±5%

**自动审核流程**：
```
药房上传履约照片
    ↓
AI识别电子秤重量
    ↓
计算误差 = |实际重量 - 理论重量| / 理论重量
    ↓
误差 ≤ 5% → 自动审核通过 → 生成PO
    ↓
误差 > 5% → 转人工审核
    ↓
人工审核结果不影响患者取药（业务流程独立）
```

**技术实施要点**：
- **数据库扩展**：处方表新增total_weight_grams字段
- **计算时机**：处方创建/修改时自动计算并更新
- **容错机制**：AI识别失败时自动转人工审核
- **审核记录**：保存AI识别结果和人工审核决策用于系统改进

### 2. 自动PO生成和结算

#### 用户需求描述
> "系统立即根据该报价单的内容自动生成采购订单"

#### 批判性分析（已澄清）
**业务流程优化**：
- **价格透明化**：平台与药房之间只关于采购价计费，该费用及有货情况由药房用户自行上传和维护
- **审核流程**：每次上传价目表需由管理员审核后生效，因此必须在生效前一周提交；单品有货/无货更改无需管理员审核
- **PO生成流程**：该purchase order为与指定唯一处方绑定的采购订单，当且仅当药房通过扫码获取到该张处方信息完成抓药和包装并且上传了履约凭证，才成为该处方的指定履约记录，系统根据该记录生成对应药品品种和数量的PO，可被管理员和药房端查询到具体PO信息，并且在医师端更新处方状态为"已取货"
- **审计要求**：完整的财务记录和可追溯性

#### PO生成错误处理机制方案-事务回滚机制
- **技术实现**：使用数据库事务，PO生成失败时回滚所有相关状态
- **优点**：
  - 数据一致性强，确保系统状态完整性
  - 实现相对简单，利用数据库ACID特性
  - 错误恢复彻底，无残留数据问题
- **缺点**：
  - 性能开销较大，可能影响并发处理
  - 长事务可能导致锁等待问题
  - 回滚操作可能影响其他正在进行的操作
- **适用场景**：数据一致性要求极高，并发量不大的情况

---

### 👥 患者端需求分析与建议

### 1. 地理位置服务

#### 用户需求描述
> "基于患者所在位置展示附近的合作药房，按距离排序"

#### 批判性分析
**隐私和成本考虑不足**：
- 位置数据的隐私保护
- 地图服务的成本控制
- 准确性与性能的平衡

#### 最佳实践建议
**技术方案平衡**：
- **免费方案**：OpenStreetMap + Leaflet（基础功能）
- **付费方案**：Google Maps API（高级功能，按需启用）
- **隐私保护**：最小化位置数据收集，本地处理优先
- **性能优化**：缓存机制、CDN加速

### 2. 患者反馈系统

#### 用户需求描述
> "患者可在移动端扫码触发填写问卷反馈功能"

#### 批判性分析
**数据价值和隐私平衡**：
- 反馈数据的商业价值未明确
- 隐私保护措施不够详细
- 用户参与激励机制缺失

#### 最佳实践建议
**系统设计优化**：
- **数据最小化**：只收集必要的反馈信息
- **匿名化处理**：完全去标识化，保护患者隐私
- **激励机制**：考虑适当的反馈激励（积分、优惠等）
- **数据应用**：明确反馈数据的使用目的和价值

---

### ⚖️ 需求冲突与架构一致性分析

### 1. 认证系统复杂性
**冲突**：多前端应用需要统一认证 vs 现有单一前端认证
**建议**：扩展现有JWT认证，实现跨域SSO，避免重构

### 2. API访问控制
**冲突**：非登录用户API访问 vs 现有全认证要求
**建议**：实现可选认证的API端点，在守卫层面处理

### 3. 药品数据管理
**冲突**：管理员统一维护 vs 药房独立维护
**建议**：建立分层数据模型，基础数据统一，特定数据独立

### 4. 财务操作自动化
**冲突**：效率需求 vs 安全控制
**建议**：实现分级自动化，小额自动，大额人工确认

---

### 🎯 关键技术决策建议

### 1. 优先级排序建议
**Phase 1（必需）**：前端解耦、认证扩展、API访问控制
**Phase 2（重要）**：履约凭证系统、账户余额扩展
**Phase 3（增值）**：电子签名、地理位置、患者反馈

### 2. 技术选型建议
- **地图服务**：先用免费方案验证需求，再考虑付费升级
- **电子签名**：分阶段实施，先简单后复杂
- **文件上传**：选择成熟的第三方服务，降低开发成本

### 3. 风险控制建议
- **财务操作**：建立完整的审计跟踪和错误恢复机制
- **数据隐私**：严格遵循新西兰隐私法规
- **系统安全**：实施多层防护，定期安全评估

---

### 📋 待用户澄清的关键问题

### 高优先级问题
1. **电子签名合规要求**：新西兰医疗行业的具体法规要求
2. **定价策略依据**：0-50 NZD处方费的市场调研数据
3. **履约证据标准**：什么构成有效的履约证据
4. **财务结算周期**：实时结算 vs 批量结算的业务需求

### 中优先级问题
1. **地图服务预算**：预期的地理位置查询频率和成本预算
2. **患者反馈用途**：收集的反馈数据如何应用于业务改进
3. **管理员权限分级**：是否需要多级管理员权限体系

---

## 🔄 下一步工作建议

1. **需求澄清会议**：针对上述关键问题进行深入讨论
2. **技术方案设计**：基于澄清后的需求制定详细技术方案
3. **原型验证**：对关键功能进行原型开发和用户验证
4. **PRD文档编写**：基于最终确认的需求编写产品需求文档

**文档状态：** 已完成需求分析和批判性建议，等待用户澄清关键问题

---

## 🎯 MVP 1.1 需求分析总结与PRD准备

### 📊 当前产品形态评估

#### MVP 1.0实际完成状态
基于深入的项目文档分析，当前产品已达到：
- **后端核心功能**：95-98%完成度
- **整体系统**：87-92%完成度  
- **业务闭环**：100%完整（医师→药房→管理员→结算）
- **技术质量**：99.6%测试通过率，企业级标准

#### 项目初心支撑度分析
**已充分实现（70-80%）**：
- 医师端高效电子处方平台
- 自动化运营成本降低
- 合规的处方管理系统

**关键缺失（20-30%）**：
- 患者端体验严重不足（仅20%完成）
- 单一前端架构限制扩展性
- 缺乏降低使用门槛的机制

### 🚀 MVP 1.1 核心目标设定

#### 战略目标
**完善生态闭环，实现项目完整初心**
- 从"医师-药房"双端平台升级为"医师-药房-患者-管理员"四端生态
- 从单一前端架构升级为可扩展的多前端微服务架构
- 从纯B2B平台扩展为B2B2C完整医疗服务平台

#### 用户价值目标
1. **患者体验提升**：从被动接收者变为主动参与者
2. **医师效率提升**：通过非登录功能和电子签名降低操作门槛
3. **平台运营效率**：通过AI审核和自动化流程减少人工干预
4. **业务扩展能力**：支持不同用户群体的差异化前端应用

### 📋 MVP 1.1 产品形态描述

#### 完成后的产品特点

**技术架构特点**：
- **多前端微服务架构**：医师、药房、患者、管理员使用不同子域名的专用应用
- **统一后端服务**：通过API网关和SSO认证支撑多前端访问
- **智能化增强**：AI图像识别自动化履约审核，减少人工工作量
- **用户友好设计**：支持非登录用户试用，降低平台使用门槛

**业务功能特点**：
- **完整患者体验**：地理位置药房查找、处方历史查看、服务反馈
- **灵活处方创建**：支持登录和非登录两种模式，满足不同使用场景
- **高效履约审核**：AI自动识别电子秤重量，人工审核仅处理异常情况
- **合规电子签名**：真正的PDF数字签名，满足新西兰法规要求

**用户体验特点**：
- **医师端**：专业化界面，支持快速处方创建和电子签名
- **患者端**：移动友好设计，支持药房导航和服务评价
- **药房端**：简化的履约流程，AI辅助的证据提交
- **管理员端**：安全的审核后台，智能化的异常处理

### 🏗️ 开发分工规划

#### 后端独立开发任务

**新增API服务**：
- 患者端API接口（用户注册、处方查询、药房信息）
- 地理位置服务API（药房距离计算、导航信息）
- 非登录用户服务API（药品搜索、处方草稿、PDF导出）
- AI图像识别API（电子秤数显识别、重量比对）
- 电子签名服务API（数字证书管理、PDF签名生成）

**业务逻辑增强**：
- 药品克重数据生成和管理
- 履约凭证AI审核流程
- 非登录用户日志记录系统
- 跨域认证和权限管理

**系统优化**：
- API速率限制和安全控制
- 数据库性能优化
- 错误处理和补偿机制

#### 前端协作开发任务

**认证系统集成**：
- 跨域SSO单点登录实现
- 多前端应用的统一认证流程
- 权限控制在前端的具体实现

**API接口对接**：
- 新增患者端API的前端集成
- 地理位置服务的前端调用
- AI审核结果的前端展示

**用户体验设计**：
- 电子签名的前端交互流程
- 非登录用户功能的界面设计
- 多前端应用的统一设计语言

#### 前端独立开发任务

**新前端应用开发**：
- 患者端移动应用（地图集成、药房导航）
- 管理员端专用后台（安全访问、审核界面）
- 医师端功能增强（签名界面、模板管理）

**用户界面优化**：
- 响应式设计适配
- 交互体验优化
- 性能优化和缓存策略

**独立功能实现**：
- 前端路由和状态管理
- 地图服务集成（OpenStreetMap/Google Maps）
- 文件上传和预览功能

### 📈 实施优先级建议

#### Phase 1：核心功能补全（6-8周）
**优先级P0**：
1. 患者端API开发（后端）
2. 地理位置服务实现（后端+前端协作）
3. 患者端应用开发（前端）

#### Phase 2：体验增强（4-6周）
**优先级P1**：
1. 非登录用户功能（后端+前端协作）
2. 电子签名系统（后端+前端协作）
3. AI履约审核（后端）

#### Phase 3：架构升级（6-8周）
**优先级P2**：
1. 多前端架构实施（前端）
2. SSO认证系统（后端+前端协作）
3. 管理员端重构（前端）

### 🎊 预期成果

**技术成果**：
- 从单体前端升级为微前端架构
- 从人工审核升级为AI辅助审核
- 从B2B平台升级为B2B2C生态平台

**业务成果**：
- 患者端体验从20%提升到90%
- 平台使用门槛显著降低
- 运营效率提升50%以上
- 为规模化扩展奠定技术基础

**用户价值**：
- 医师：更高效的处方创建和管理
- 患者：完整的医疗服务体验
- 药房：自动化的履约审核流程
- 平台：智能化的运营管理

MVP 1.1将把当前已经成熟的MVP 1.0平台，升级为一个完整、智能、可扩展的中医药电子处方生态系统，真正实现项目创建时的完整初心。

---

## 🧪 测试驱动开发策略

### 📋 开发策略概述

**核心理念**：测试优先，结果导向
- **明确功能需求**：详细定义每个功能的预期行为和业务价值
- **不提供实现指导**：避免限制开发人员的技术选择和创新空间
- **全面测试要求**：提出多维度、可量化的测试结果标准
- **成果验收导向**：通过测试结果验证功能是否满足业务需求

### 🎯 功能组件测试要求

#### 1. 患者端API服务

**功能需求**：
- 患者用户注册、登录、信息管理
- 处方历史查询和状态跟踪
- 药房信息获取和筛选

**测试验收标准**：
- **功能测试**：100%核心用例通过，包括注册、登录、查询、筛选等
- **性能测试**：API响应时间P95 < 300ms，并发100用户无错误
- **安全测试**：通过OWASP Top 10安全检查，数据加密传输验证
- **集成测试**：与现有认证系统100%兼容，数据一致性验证
- **边界测试**：异常输入处理100%覆盖，错误信息友好准确

#### 2. 地理位置服务

**功能需求**：
- 基于用户位置计算药房距离
- 提供导航路线和时间估算
- 支持地址关键词搜索

**测试验收标准**：
- **精度测试**：距离计算误差 < 5%，路线规划准确率 > 95%
- **性能测试**：位置查询响应时间 < 500ms，地图加载时间 < 2秒
- **覆盖测试**：新西兰主要城市100%覆盖，偏远地区 > 80%覆盖
- **用户体验测试**：操作流程 < 3步完成，界面响应流畅
- **兼容性测试**：支持iOS/Android/Web三端，各浏览器兼容

#### 3. 非登录用户功能

**功能需求**：
- 药品搜索和浏览
- 处方草稿创建和编辑
- PDF导出（无价格信息）

**测试验收标准**：
- **功能隔离测试**：非登录用户无法访问价格、支付、保存等功能
- **数据安全测试**：无敏感信息泄露，会话数据不持久化
- **性能测试**：搜索响应时间 < 200ms，PDF生成时间 < 3秒
- **用户体验测试**：功能限制提示清晰，引导登录转化率 > 15%
- **日志记录测试**：用户行为100%记录，数据分析维度完整

#### 4. AI图像识别系统

**功能需求**：
- 电子秤数显自动识别
- 重量数据提取和验证
- 与处方重量自动比对

**测试验收标准**：
- **识别准确率测试**：数字识别准确率 > 95%，各种秤型适配
- **性能测试**：图像处理时间 < 5秒，批量处理支持
- **鲁棒性测试**：不同光线、角度、清晰度条件下稳定性
- **业务逻辑测试**：重量比对逻辑准确，误差计算正确
- **异常处理测试**：识别失败时优雅降级，人工审核流程触发

#### 5. 电子签名系统

**功能需求**：
- 数字证书生成和管理
- PDF数字签名嵌入
- 签名验证和法规合规

**测试验收标准**：
- **合规性测试**：符合新西兰电子交易法案，PDF阅读器可验证
- **安全性测试**：证书加密存储，私钥安全管理
- **功能测试**：签名生成成功率100%，验证准确率100%
- **性能测试**：签名生成时间 < 10秒，证书管理响应快速
- **用户体验测试**：签名流程直观简单，错误处理友好

#### 6. 多前端架构系统

**功能需求**：
- 子域名路由和应用隔离
- 统一认证和权限管理
- 跨域通信和状态同步

**测试验收标准**：
- **架构测试**：各前端应用独立部署，互不影响
- **认证测试**：SSO单点登录100%可用，权限控制准确
- **性能测试**：应用切换无感知，加载时间 < 3秒
- **兼容性测试**：各前端应用在不同设备和浏览器正常运行
- **维护性测试**：代码复用率 > 60%，新应用接入成本低

### 📊 综合系统测试要求

#### 端到端业务流程测试
**完整业务链路**：
- 患者查找药房 → 医师创建处方 → 药房履约 → AI审核 → 自动结算
- **测试标准**：端到端流程成功率 > 98%，各环节无数据丢失

#### 系统集成测试
**多系统协作**：
- 新功能与MVP 1.0现有功能100%兼容
- 数据迁移和状态同步无错误
- **测试标准**：集成后系统稳定性保持，性能无显著下降

#### 压力和负载测试
**系统容量**：
- 支持1000+并发用户，10000+日活跃用户
- **测试标准**：高负载下响应时间增长 < 50%，错误率 < 0.1%

#### 安全性测试
**全面安全检查**：
- 通过渗透测试，无高危漏洞
- **测试标准**：符合医疗数据保护法规，用户隐私100%保护

### 🎯 验收交付标准

#### 功能完整性
- 所有需求功能100%实现并通过测试
- 业务流程完整闭环，无功能缺失

#### 质量标准
- 代码测试覆盖率 > 85%
- 性能指标100%达标
- 安全检查100%通过

#### 文档完整性
- API文档100%覆盖
- 用户手册和操作指南完整
- 技术文档和部署指南齐全

#### 生产就绪性
- 监控和告警系统完整
- 错误处理和恢复机制健全
- 数据备份和灾难恢复方案就绪

通过这种测试驱动的开发策略，确保MVP 1.1的每个功能组件都能达到生产级别的质量标准，同时给予开发团队充分的技术选择自由度和创新空间。



## 📋 PRD制定前的必要准备工作

### 🎯 业务决策确认

#### 1. 商业模式验证
- **盈利模式确认**：MVP 1.1新功能的收费策略（患者端是否收费、AI审核是否降低成本等）
- **市场定位调整**：从B2B向B2B2C转型的市场策略和竞争分析
- **ROI预期设定**：MVP 1.1投资回报预期和成功指标定义

#### 2. 用户研究补充
- **患者端用户画像**：目标患者群体特征、使用习惯、痛点分析
- **现有用户反馈**：MVP 1.0医师和药房用户对新功能的需求优先级
- **竞品分析更新**：同类产品的患者端功能和用户体验benchmarking

### 📊 技术决策澄清

#### 3. 技术选型确认
- **地图服务商选择**：Google Maps vs OpenStreetMap的成本效益分析
- **AI服务提供商**：自建OCR vs 第三方API的技术和成本对比
- **前端架构方案**：微前端具体技术栈选择（Module Federation、Single-SPA等）

#### 4. 基础设施规划
- **服务器资源预算**：新功能对服务器资源的需求评估
- **第三方服务预算**：地图、AI、CDN等服务的年度预算规划
- **数据存储策略**：患者数据、图像文件、日志数据的存储和备份策略

### 🏗️ 项目管理准备

#### 5. 团队资源配置
- **开发团队组成**：前端、后端、测试人员的具体配置和技能要求
- **项目时间规划**：18-20周开发周期的详细里程碑和交付节点
- **外部协作需求**：是否需要UI/UX设计师、产品经理等外部资源

#### 6. 风险管理计划
- **技术风险评估**：AI识别准确率、地理位置服务稳定性等技术风险
- **业务风险评估**：用户接受度、市场竞争、法规变化等业务风险
- **应急预案制定**：关键功能失败时的降级方案和回滚策略

### 📋 合规和法务准备

#### 7. 法规合规确认
- **患者隐私保护**：新西兰隐私法对患者数据收集和使用的具体要求
- **电子签名法规**：数字签名的法律效力确认和实施细节
- **医疗数据安全**：患者健康信息的存储、传输、访问控制要求

#### 8. 商业协议更新
- **用户协议修订**：患者端用户协议、隐私政策的制定
- **药房合作协议**：AI审核、自动结算等新流程的合同条款
- **第三方服务协议**：地图、AI等第三方服务的商业合同

### 🎨 用户体验设计

#### 9. UI/UX设计规范
- **设计系统建立**：多前端应用的统一设计语言和组件库
- **用户体验流程**：关键用户路径的详细交互设计
- **响应式设计标准**：移动端、平板、桌面端的适配要求

#### 10. 可用性测试计划
- **原型测试方案**：关键功能的用户测试计划和成功指标
- **A/B测试策略**：非登录用户转化、患者端功能使用等测试设计
- **用户反馈收集**：Beta测试用户的招募和反馈收集机制

### 📈 数据和监控准备

#### 11. 数据分析框架
- **关键指标定义**：患者活跃度、转化率、AI审核准确率等KPI
- **数据收集策略**：用户行为数据、业务数据、技术指标的收集方案
- **报表和仪表板**：管理层和运营团队的数据可视化需求

#### 12. 运营支持准备
- **客服培训材料**：新功能的用户支持和问题解决指南
- **运营手册更新**：AI审核异常处理、患者投诉处理等运营流程
- **营销推广策略**：MVP 1.1新功能的市场推广和用户教育计划

## 🎯 建议的准备工作优先级

### 高优先级（必须完成）
1. 商业模式和盈利策略确认
2. 技术选型和基础设施预算
3. 法规合规要求澄清
4. 团队资源和时间规划

### 中优先级（建议完成）
5. 用户研究和竞品分析
6. UI/UX设计规范制定
7. 风险管理和应急预案
8. 数据分析框架设计

### 低优先级（可并行进行）
9. 运营支持材料准备
10. 营销推广策略制定

完成这些准备工作后，PRD文档将能够提供：
- **清晰的产品目标**和成功指标
- **详细的功能规格**和技术要求  
- **明确的项目计划**和资源配置
- **完整的风险评估**和应对策略
- **可执行的测试标准**和验收条件

这样制定出的PRD将是一个真正可执行、可衡量、可交付的产品需求文档。

## 隐私合规
为了解决对“服务器端解密”、“拖库泄露明文”和“鉴权失误”的担忧，并提供具体的架构设计指导和开源实践参考，我们将聚焦于**应用层加密 (Application-Layer Encryption - ALE)** 和**强大的身份与访问管理 (IAM)**，结合**统一患者身份数据模型**，构建一个**精益但安全可靠**的系统架构。

这个方案的目标是：
1.  **数据在数据库中尽可能以加密形式存在**，降低拖库风险。
2.  **严格控制谁、何时、为何能看到明文数据**。
3.  **最小化平台管理员直接访问明文数据的能力**。
4.  **提供可扩展的、符合精益创业原则的实现路径**。

---

**一、 架构设计概览 (精益安全架构)**

这是一个分层的安全架构，每层都有其职责，即使一层被攻破，下一层也能提供保护。

```
+-------------------+                                                                     +--------------------+
|  Doctor Web/Mobile App  |                                                                     |  Pharmacy App/Web   |
+---------+---------+                                                                     +---------+----------+
          | HTTPS/TLS (Encrypted Transit)                                                            | HTTPS/TLS (Encrypted Transit)
          v                                                                                        v
+----------------------------------------------------------------------------------------------------------------+
|                                    API Gateway (Rate Limiting, WAF, DDoS Protection)                           |
+----------------------------------------------------------------------------------------------------------------+
          | HTTPS/TLS                                                                                             
          v                                                                                               
+----------------------------------------------------------------------------------------------------------------+
|                                     Backend Services (Application Layer)                                       |
|                                                                                                                |
|  +---------------------+   +---------------------+   +---------------------+   +--------------------------+  |
|  | Authentication/     |   | Authorization/RBAC  |   | Data Processing/    |   | Key Management Service   |  |
|  | Authorization Svc   |<->| (Policy Enforcement)|<->| Encryption/Decryption|<->| (KMS) - e.g., HashiCorp Vault |  |
|  | (e.g., Keycloak)    |   |                     |   | (Application Layer) |   |                          |  |
|  +---------+-----------+   +---------------------+   +---------+-----------+   +--------------------------+  |
|            |                                                    |                                               |
|            | Identity Verification (Login)                      | Encrypted Data Access (Patient Data, Prescriptions) |
|            v                                                    v                                               |
|  +---------------------+                                +---------------------+                               |
|  | Identity Store      |                                | Database (Encrypted) |                               |
|  | (User Passwords, MFA)|                                | (Patient Master,     |                               |
|  +---------------------+                                | Prescriptions, etc.)|                               |
|                                                                                                                |
|                                    Audit Logging & Monitoring Service (Centralized, Immutable)                 |
+----------------------------------------------------------------------------------------------------------------+

```

**核心思想：**

*   **数据模型统一：** 患者（`Patient`）只有一个主记录（姓名、生日等），处方（`Prescription`）关联到患者 ID 和开方医生 ID。
*   **应用层加密 (ALE)：** 敏感数据（姓名、生日、处方明细）在进入数据库前，由应用服务加密。
*   **独立密钥管理 (KMS)：** 加密解密密钥不存储在应用服务或数据库中，由独立且高度安全的 KMS 管理。
*   **严格访问控制：** 谁能看到明文，由授权服务（RBAC）和数据归属（医生-患者关联）决定。
*   **强制审计：** 所有敏感操作都被记录。

---

**二、 关键组件与技术实践**

**1. 患者数据模型 (Unified Patient Identity)**

*   **设计：**
    *   `Patients` 表：`patient_id` (UUID), `encrypted_name`, `encrypted_dob`, `encrypted_contact_info`, `created_by_doctor_id`, `created_at`。
    *   `Prescriptions` 表：`prescription_id` (UUID), `patient_id` (FK to `Patients`), `doctor_id` (FK to `Doctors`), `encrypted_prescription_details`, `created_at`, `status`。
*   **优点：** 避免数据冗余，实现唯一身份管理，方便权限绑定。

**2. 应用层加密 (Application-Layer Encryption - ALE)**

*   **原理：** 在数据写入数据库之前，在后端应用代码中对敏感字段进行加密；从数据库读取后，在后端应用代码中进行解密。
*   **如何实现：**
    *   **加密算法：** AES-256 GCM (Galois/Counter Mode) 是行业标准，提供保密性、完整性和认证性。
    *   **密钥管理：** 这是 ALE 的核心。
        *   **数据加密密钥 (DEK):** 用于加密实际数据的密钥。每个患者记录可以有自己的 DEK，或者多个患者共享一个 DEK ( tradeoff between security and management overhead)。
        *   **密钥加密密钥 (KEK):** 用于加密 DEK 的密钥。KEK 存储在 KMS 中。
        *   **工作流程：**
            1.  当医生创建患者记录时，应用生成一个新的 DEK。
            2.  应用用 DEK 加密患者的姓名、生日等敏感信息。
            3.  应用请求 KMS 使用 KEK 加密 DEK，然后将加密后的 DEK 连同加密数据一起存入数据库。
            4.  当授权医生请求查看患者信息时，应用从数据库读取加密数据和加密的 DEK。
            5.  应用请求 KMS 用 KEK 解密 DEK。
            6.  应用用解密后的 DEK 解密患者数据，然后将明文发送到前端。
    *   **搜索挑战：** ALE 使得直接在数据库中搜索加密数据变得困难。
        *   **解决方案：**
            *   **同态加密 (Homomorphic Encryption):** 理论上可行，但目前性能开销巨大，不适合生产。
            *   **可搜索加密 (Searchable Encryption):** 允许在密文上执行搜索，但实现复杂。
            *   **索引字段的哈希/部分哈希/加密哈希：** 对于需要搜索的字段（如患者姓名），可以在加密的同时，存储一个**不安全但可搜索的哈希值**（或加盐的哈希）。这个哈希值用于数据库搜索，但**不能用于解密**。只能用作筛选条件，最终结果仍需通过 ALE 解密验证。例如，存储姓名的哈希值用于搜索，实际姓名加密。
            *   **使用非敏感字段作为搜索键：** 如果医生可以通过平台生成的 `patient_id` 或其他非敏感的唯一标识来搜索患者，则可以避免在敏感字段上进行搜索。
    *   **开源实践参考：**
        *   **语言自带加密库：** Python (PyCryptodome), Node.js (`crypto` module), Java (JCE) 等都有实现 AES-256 GCM 的库。
        *   **KMS (Key Management System):**
            *   **HashiCorp Vault (开源)：** 功能强大，可用于管理 DEK/KEK。但部署和运维复杂度较高，可能需要专业的 DevOps/安全人员。
            *   **云服务 KMS (推荐)：** AWS KMS, Azure Key Vault, Google Cloud KMS。它们提供托管的、符合最高安全标准的 KMS 服务，将密钥的物理和逻辑安全管理交由云服务商，大大降低了初创公司的负担。这是在 Lean Compliance 下的首选。

**3. 身份与访问管理 (Identity & Access Management - IAM)**

*   **鉴权 (Authentication):**
    *   **多因素认证 (MFA)：** 强制所有用户（医生、药店、平台管理员）使用 MFA。
    *   **强密码策略：** 强制。
    *   **开源实践参考：**
        *   **Keycloak (开源)：** 功能强大，提供 SSO、MFA、RBAC 等，可自托管。但部署和运维也需要专业知识。
        *   **Managed Auth Services (推荐)：** Auth0, Okta, Firebase Authentication。它们通常有免费层或低成本层，并内置 MFA。可以快速集成。
*   **授权 (Authorization - RBAC with Data Ownership):**
    *   **核心逻辑：** 平台后端服务在每次数据请求时，严格验证：
        *   `当前登录用户 (Doctor A)` 是否被授权访问 `Patient P` 的数据？
        *   权限检查基于 `Prescription.doctor_id` 或 `Patient.created_by_doctor_id` 与 `Doctor A.id` 的匹配。
        *   对于平台管理员，默认无权解密明文。只有在特定审计流程下，通过 KMS 临时授权，并严格记录解密行为。
    *   **开源实践参考：**
        *   大多数 Web 框架（Django, Spring Security, Node.js Express）都有强大的 RBAC 中间件或库，允许你实现自定义授权策略。
        *   **Open Policy Agent (OPA) (开源)：** 如果未来授权策略非常复杂（例如：多诊所共享、高级转诊规则），OPA 允许你将授权策略外部化和集中管理。

**4. 审计追踪与监控 (Audit Logging & Monitoring)**

*   **强制记录：** 所有对敏感数据的**解密操作、访问操作、修改、删除操作、以及所有登录尝试和鉴权失败**，都必须被记录。
*   **日志内容：** 谁（用户ID/IP）、何时、何地、做了什么（操作类型）、操作结果、受影响的数据 ID。
*   **日志安全：** 日志必须发送到独立、安全的日志服务，确保不可篡改，且不能被日志生成者轻易修改或删除。
*   **监控与告警：** 实时监控日志，对异常模式（如同一用户短时间内多次解密大量数据、异常登录尝试）触发告警。
*   **开源实践参考：**
    *   **ELK Stack (Elasticsearch, Logstash, Kibana) / Grafana Loki：** 强大的开源日志聚合、搜索和可视化工具。
    *   **Prometheus + Grafana：** 用于系统性能和业务指标监控，可与告警系统集成。

**5. 网络与基础设施安全**

*   **云服务商选择 (推荐)：** AWS, Azure, Google Cloud。他们提供了物理安全、网络隔离（VPC）、DDoS 防护、WAF (Web Application Firewall) 等基础安全服务，将这部分重资产和复杂性转嫁给云服务商。
*   **安全组/防火墙：** 严格限制各个组件（数据库、应用服务器）之间的网络通信，只开放必要的端口和协议。
*   **定期漏洞扫描：** 使用开源工具（如 OWASP ZAP, Nmap）进行基础的 Web 应用程序和网络漏洞扫描。

---

**三、 “精益合规”的实践路径**

1.  **MVP 阶段 (0-6个月)：**
    *   **法律咨询：** 优先完成，确保 DPA、隐私政策等法律文档。
    *   **云基础设施：** 选择一家云服务商，利用其 HTTPS、数据库 TDE、IAM、VPC 等基础安全能力。
    *   **核心 ALE：** 至少对患者姓名和处方明细的关键字段实现应用层加密。
    *   **基础 RBAC：** 实现医生只能看自己的患者，药店只能看特定凭证。
    *   **基础审计日志：** 记录登录、关键数据访问、核销等核心操作。
    *   **MFA：** 强制医生和平台员工使用。
    *   **创始人作为安全官：** 亲自监督，进行内部安全培训。
    *   **不追求认证：** 此时无需任何昂贵的认证。

2.  **增长阶段 (6-18个月)：**
    *   **完善 ALE：** 扩展到所有敏感字段。
    *   **强化 KMS：** 如果前期没有用托管 KMS，考虑迁移到云服务商的托管 KMS。
    *   **自动化测试：** 增加安全相关的单元测试、集成测试。
    *   **安全审计：** 考虑进行一次外部的渗透测试 (Penetration Test) 来发现潜在漏洞。
    *   **数据模型优化：** 如果开始出现患者信息重叠，实施统一患者身份模型。

3.  **规模化阶段 (18个月+):**
    *   **专业安全团队：** 招聘专门的安全工程师。
    *   **安全认证：** 考虑 ISO 27001 等认证，以提升市场信任度。
    *   **高级安全工具：** 如专业的 WAF、IDS/IPS、SIEM (安全信息和事件管理)。

**总结：**

**“只有起初录入该患者的医生才能看到明文”** 这个需求，不应通过私钥直接匹配的方式来实现，而应通过**应用层加密 (ALE) 结合严格的基于数据归属的 RBAC** 来实现。数据库中所有敏感信息都是加密的，只有在授权的请求下，后端应用才从 KMS 获取密钥，解密数据，并通过安全通道发送到前端显示。

这种架构设计，既能满足你的安全需求，又能兼顾初创公司的资源限制，是当前业界在医疗健康领域推荐的精益而安全的实践。