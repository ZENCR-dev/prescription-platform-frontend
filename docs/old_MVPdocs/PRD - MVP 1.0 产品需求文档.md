**文档版本：** 1.0
**日期：** [当前日期]
**负责人：** [你的名字] (产品经理)
**关联文档：** SOP 0.5 (综合决策版), MVP 0.8 PRD/SOP (前端原型)

### **1. 引言**

#### **1.1 项目目标**

本 PRD 定义了新西兰中医处方平台 MVP 1.0 阶段的功能需求。MVP 1.0 的核心目标是**将已完成的、功能丰富的纯前端原型 (MVP 0.8) 对接一个稳定、可靠的后端系统，打通核心业务流程，并上线进行真实市场验证**。

我们将聚焦于为新西兰中医师提供一个现代化的电子处方及草药调配协作平台，**解决其自建药房成本高、运营复杂的痛点**，同时通过引入**高效的处方模板和历史管理功能**，显著提升其工作效率和用户粘性。

#### **1.2 核心业务逻辑 (基于 SOP 0.5)**

平台采用 **“诊所预付/信用额度”** 模式，确保平台财务风险可控。核心流程如下：

1.  **医生开方与支付：** 医生使用平台开具处方，系统从其关联诊所的预付/信用账户中**实时扣除**订单成本 (B)，生成**有效凭证** (二维码)。
2.  **凭证交付：** 医生通过打印/邮件等方式将凭证交付给患者。
3.  **药房履约与验证：** 患者持凭证到合作药房。药房扫码后，平台后端通过 **P1-P2 API** 验证订单真实性。药房完成配药并上传履约照片。
4.  **审核与结算：** 平台管理员**手动审核**履约凭证。审核通过后，系统**自动触发**与药房的结算流程 (支付 C)。

### **2. 用户角色与权限**

*   **核心用户角色：** 医生 (Doctor), 药房操作员 (Pharmacy Operator), 平台管理员 (Admin)。
*   **未来用户角色：** 患者 (Patient)。
*   **权限模型：** 严格遵循 SOP 0.5 中定义的 **用户角色权限矩阵**，后端需实现相应的 RBAC (Role-Based Access Control) 机制。

### **3. 功能需求 (MVP 1.0)**

#### **3.1 核心业务闭环 (优先级 P0)**

| 功能模块 | 功能点 | 用户故事 (As a... I want to... so that...) | 后端支持需求 (MVP 1.0) |
| :--- | :--- | :--- | :--- |
| **医生开方** | 1. 创建处方 | 作为一名**医生**，我希望能快速搜索药品、设置剂量和帖数、添加医嘱，以高效地创建一张完整的电子处方。 | - 提供药品目录查询 API (支持模糊搜索、分页)。<br>- 提供创建处方/订单的 API，处理处方项、患者信息、备注等。 |
| | 2. 诊所账户支付 | 作为一名**医生**，我希望在提交处方时，系统能自动从我诊所的预付账户扣款，并立即告知我结果，以便我能确认处方是否生效。 | - 实现**诊所信用/预付账户体系** (CRUD)。<br>- 实现订单创建时**实时、可靠地扣除账户额度/预付款**的事务性操作。<br>- 扣款失败时返回明确的错误信息。 |
| | 3. 生成有效凭证 | 作为一名**医生**，我希望支付成功后能立即获得一个包含二维码的、清晰的电子凭证，方便我打印或发送给患者。 | - 订单支付成功后，后端生成包含订单核心信息的 **QR 码数据**。<br>- 提供 API 供前端获取订单详情和 QR 码数据。 |
| **药房履约** | 4. 验证订单 | 作为一名**药房操作员**，我希望在扫描患者的二维码后，系统能立即验证订单的真伪和核心内容，以避免处理无效或错误的订单。 | - 提供 **P1-P2 订单信息验证 API**，接收订单号，返回订单的真实 SKU、数量等核心信息。 |
| | 5. 提交履约凭证 | 作为一名**药房操作员**，我希望在配药完成后，能方便地上传一张履约照片作为凭证，以完成我的履约流程。 | - 提供**文件上传服务** (通过签名 URL 方式)。<br>- 提供 API 允许药房提交履约凭证（包含文件 ID 和备注），并更新订单状态为 `PENDING_REVIEW`。 |
| **管理员审核** | 6. 手动审核 | 作为一名**管理员**，我希望能在一个清晰的界面上查看药房提交的履约凭证（包括照片），并进行“通过”或“拒绝”的操作，以确保履约质量。 | - 提供查询 `PENDING_REVIEW` 状态订单的 API。<br>- 提供审核履约凭证的 API，接收审核结果并更新订单状态。 |
| **平台结算** | 7. 自动触发结算 | 作为一名**管理员**，我希望在我批准履约凭证后，系统能自动生成与药房的结算记录，减少我的人工财务操作。 | - **自动化业务逻辑**：在订单状态变为 `FULFILLED` 时，**自动创建**一条待支付的结算记录。 |
| | 8. 标记支付与通知 | 作为一名**管理员**，我希望在完成对药房的线下转账后，能在后台将结算记录标记为“已支付”，并自动通知药房。 | - 提供 API 更新结算记录状态。<br>- **自动化业务逻辑**：在结算记录状态变为 `PAID` 时，**自动触发**邮件通知给药房。 |

#### **3.2 关键支撑功能 (基于 MVP 0.8 原型)**

| 功能模块 | 功能点 | 用户故事 | 后端支持需求 (MVP 1.0) | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| **用户与认证** | 9. 统一认证与授权 | 作为一名**平台用户**，我希望能通过统一的登录入口访问为我授权的功能，并确保我的数据安全。 | - 实现统一的 JWT 签发、校验、刷新机制 (封装 Supabase Auth)。<br>- 实现基于角色的 API 权限控制 (RBAC)。 | P0 |
| **医师工作站** | 10. **处方模板管理** | 作为一名**医生**，我希望能创建、编辑、复制和使用我的常用处方模板，以大幅缩短开具重复处方的时间。 | - 提供处方模板的 **CRUD API**。<br>- 支持按医生 ID 查询其个人模板列表。 | P1 |
| | 11. **处方历史查看** | 作为一名**医生**，我希望能方便地查看我开具过的所有处方历史记录，并按状态或患者进行筛选，以便于复诊和跟踪。 | - 提供查询医生个人处方历史的 API (支持分页、按状态/关键词筛选)。 | P1 |
| **患者体验** | 12. 药房查找 | 作为一名**患者**（或代其操作的医生），我希望能在一个公开页面上，根据我的位置查找附近有哪些合作药房，并了解它们大致的药品供应能力。 | - 提供查询药房列表的公开 API (支持地理位置查询)。<br>- 后端需维护药房的供应能力数据（非实时库存），并在 API 中支持按药品 SKU 进行筛选。 | P1 |
| **市场推广** | 13. 医生推荐机制 | 作为一名**医生**，我希望能通过分享我的推荐码邀请同行加入，并获得平台奖励，帮助平台成长的同时也让我获益。 | - 后端需支持推荐码的生成、验证和关联逻辑。<br>- 提供 API 查询推荐关系和统计数据。 | P2 |
| **管理后台** | 14. 基础数据管理 | 作为一名**管理员**，我需要能查看平台的用户、药品、药房列表，以进行日常的运营监控。 | - 提供用户、药品、药房列表的基础查询 API (支持分页、筛选、排序)。 | P2 |
| | 15. 基础报表 | 作为一名**管理员**，我希望能在一个仪表盘上看到平台最核心的运营数据（如活跃医生数、订单量、GTV），以便快速了解业务健康状况。 | - 提供计算和查询核心 KPI 的 API。 | P3 |

#### **3.3 订单状态机 (基于 SOP 0.5 最终版)**

后端 `Order Service` 中的状态机必须严格遵循已确认的订单状态机图（修改版），包括其状态定义、流转逻辑和业务规则。

| 状态 (Status) | UI 显示 | 用户操作 | 触发条件/逻辑 |
| :--- | :--- | :--- | :--- |
| **DRAFT** | 草稿 | 编辑、删除、提交 | 医生创建处方 |
| **PAYMENT_FAILED** | 支付失败 | 重新支付、取消 | 提交处方但扣款失败 |
| **PAID** | 已支付 | 查看详情、生成二维码 | 提交处方且扣款成功 |
| **PENDING_REVIEW** | 审核中 | 管理员:审核 | 药房提交履约凭证 |
| **REJECTED** | 审核拒绝 | 药房:重新提交凭证 | 管理员审核拒绝 |
| **FULFILLED** | 已完成 | 查看详情、下载凭证 | 管理员审核通过 |
| **CANCELLED** | 已取消 | 查看取消原因 | 用户取消或系统触发 |
| **EXPIRED** | 已过期 | 查看详情 | 48小时未履约 |

### **4. 非功能性需求**

| 类别 | 需求描述 |
| :--- | :--- |
| **性能** | - 核心 API (如订单创建、药品搜索) 响应时间应在 500ms 以内。<br>- 平台需能支持初期 100 名医生同时在线操作的并发量。 |
| **安全** | - 遵循 Security by Design 原则，实现用户认证、授权 (RBAC) 和数据校验。<br>- 对敏感数据（如密码、API密钥）进行加密存储。<br>- 防止常见的 Web 攻击（XSS, CSRF, SQL注入等）。 |
| **可靠性** | - 系统核心业务流程可用性需达到 99.9%。<br>- 数据库和文件存储需有可靠的备份和恢复机制。 |
| **可维护性** | - 后端服务需模块化，遵循清晰的设计模式。<br>- 提供完善的 API 文档 (OpenAPI/Swagger)。<br>- 关键业务逻辑需有单元测试和集成测试覆盖。 |
| **合规性** | - 遵循新西兰数据隐私法规 (Privacy Act 2020)。<br>- 在引入真实数据和交易前，完成法律与财税咨询。 |

### **5. 成功指标 (KPIs)**

MVP 1.0 上线后，我们将重点追踪以下核心指标，以评估产品成功与否：

| KPI 分类 | 指标名称 | 衡量目标 |
| :--- | :--- | :--- |
| **用户增长与活跃度** | 月活跃医师 (MAU) | 核心用户粘性与产品价值体现。 |
| | 医师留存率 (Doctor Retention) | 产品对现有用户的持续吸引力。 |
| **业务与履约效率** | 月总订单数 | 平台业务规模。 |
| | 订单履约率 (Order Fulfillment Rate) | 核心业务流程的顺畅度。 |
| **财务表现** | 月度总交易额 (GTV - 基于B价) | 平台业务规模。 |
| | 月度毛利总额 (Gross Profit) | 平台核心盈利能力。 |

---

**结论：**

这份 PRD 1.0 旨在为后端团队提供一份清晰、准确、可执行的需求蓝图。它充分利用了 MVP 0.8 前端原型的成果，并融入了我们核心小组多轮讨论的战略决策。我相信，基于这份 PRD 进行开发，将能确保我们的 MVP 1.0 产品精准地命中市场痛点，并为后续的快速迭代和商业成功奠定坚实的基础。