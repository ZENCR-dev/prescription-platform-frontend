<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>双因素认证 - 中医处方平台 | Two-Factor Auth - TCM Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sage': {
                            DEFAULT: '#7e998a',
                            50: '#f6f7f6',
                            100: '#e5ebe8',
                            200: '#ccd7d1',
                            300: '#b2c2b9',
                            400: '#98aea2',
                            500: '#7e998a',
                            600: '#637e6f',
                            700: '#4a5e53',
                            800: '#313f37',
                            900: '#191f1c'
                        },
                        'cambridge': {
                            DEFAULT: '#7fbeab',
                            50: '#f0f6f4',
                            100: '#e5f2ee',
                            200: '#cbe5dd',
                            300: '#b2d8cd',
                            400: '#98cbbc',
                            500: '#7fbeab',
                            600: '#55a88f',
                            700: '#407e6b',
                            800: '#2a5448',
                            900: '#152a24'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 语言切换器 -->
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleLanguage()" 
                class="px-4 py-2 bg-white/80 backdrop-blur border border-gray-200 rounded-full text-sm font-medium text-gray-700 hover:bg-white transition-all shadow-sm flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
            </svg>
            <span id="lang-toggle-text">English</span>
        </button>
    </div>

    <!-- 主容器 -->
    <div class="min-h-screen flex items-center justify-center px-4 py-8">
        <div class="w-full max-w-2xl">
            <!-- 标题 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-light text-sage-800 mb-2">
                    <span class="zh">双因素认证设置</span>
                    <span class="en hidden">Two-Factor Authentication Setup</span>
                </h1>
                <p class="text-gray-500">
                    <span class="zh">为您的账户添加额外的安全保护</span>
                    <span class="en hidden">Add an extra layer of security to your account</span>
                </p>
            </div>

            <!-- 设置步骤 -->
            <div class="bg-white shadow-sm border border-gray-100">
                <!-- 步骤指示器 -->
                <div class="flex items-center justify-between px-8 py-4 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-cambridge-600 text-white rounded-full flex items-center justify-center text-sm font-medium">1</div>
                        <span class="text-sm font-medium text-gray-700">
                            <span class="zh">安装认证应用</span>
                            <span class="en hidden">Install Authenticator</span>
                        </span>
                    </div>
                    <div class="h-px bg-gray-200 flex-1 mx-4"></div>
                    <div class="flex items-center gap-3">
                        <div id="step2-indicator" class="w-8 h-8 bg-gray-200 text-gray-400 rounded-full flex items-center justify-center text-sm font-medium">2</div>
                        <span class="text-sm text-gray-400">
                            <span class="zh">扫描二维码</span>
                            <span class="en hidden">Scan QR Code</span>
                        </span>
                    </div>
                    <div class="h-px bg-gray-200 flex-1 mx-4"></div>
                    <div class="flex items-center gap-3">
                        <div id="step3-indicator" class="w-8 h-8 bg-gray-200 text-gray-400 rounded-full flex items-center justify-center text-sm font-medium">3</div>
                        <span class="text-sm text-gray-400">
                            <span class="zh">验证设置</span>
                            <span class="en hidden">Verify Setup</span>
                        </span>
                    </div>
                </div>

                <!-- 步骤1：选择认证应用 -->
                <div id="step1" class="p-8">
                    <h2 class="text-xl font-light text-gray-800 mb-4">
                        <span class="zh">选择您的认证应用</span>
                        <span class="en hidden">Choose Your Authenticator App</span>
                    </h2>
                    
                    <p class="text-gray-600 mb-6">
                        <span class="zh">请在您的手机上安装以下任一认证应用：</span>
                        <span class="en hidden">Install one of these authenticator apps on your phone:</span>
                    </p>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <!-- Google Authenticator -->
                        <div class="border border-gray-200 p-4 text-center hover:border-cambridge-300 transition-colors cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 48 48">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                                <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                                <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                                <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                            </svg>
                            <p class="text-sm font-medium text-gray-700">Google Authenticator</p>
                        </div>

                        <!-- Microsoft Authenticator -->
                        <div class="border border-gray-200 p-4 text-center hover:border-cambridge-300 transition-colors cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 48 48">
                                <path fill="#ff5722" d="M6 6H22V22H6z"/>
                                <path fill="#4caf50" d="M26 6H42V22H26z"/>
                                <path fill="#ffc107" d="M6 26H22V42H6z"/>
                                <path fill="#03a9f4" d="M26 26H42V42H26z"/>
                            </svg>
                            <p class="text-sm font-medium text-gray-700">Microsoft Authenticator</p>
                        </div>

                        <!-- Authy -->
                        <div class="border border-gray-200 p-4 text-center hover:border-cambridge-300 transition-colors cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 48 48">
                                <circle cx="24" cy="24" r="20" fill="#ec1c24"/>
                                <path fill="white" d="M24,14c-5.5,0-10,4.5-10,10s4.5,10,10,10s10-4.5,10-10S29.5,14,24,14z M24,30c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S27.3,30,24,30z"/>
                            </svg>
                            <p class="text-sm font-medium text-gray-700">Authy</p>
                        </div>
                    </div>

                    <div class="bg-cambridge-50 p-4 rounded-sm mb-6">
                        <p class="text-sm text-cambridge-700">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="zh">提示：推荐使用Google Authenticator，它支持离线使用且安全可靠。</span>
                            <span class="en hidden">Tip: We recommend Google Authenticator for offline use and reliability.</span>
                        </p>
                    </div>

                    <button onclick="goToStep2()" 
                            class="w-full py-3 bg-sage-600 text-white font-light tracking-wide hover:bg-sage-700 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        <span class="zh">下一步：扫描二维码</span>
                        <span class="en hidden">Next: Scan QR Code</span>
                    </button>
                </div>

                <!-- 步骤2：扫描二维码 -->
                <div id="step2" class="p-8 hidden">
                    <h2 class="text-xl font-light text-gray-800 mb-4">
                        <span class="zh">扫描二维码</span>
                        <span class="en hidden">Scan QR Code</span>
                    </h2>
                    
                    <p class="text-gray-600 mb-6">
                        <span class="zh">使用您的认证应用扫描下方二维码：</span>
                        <span class="en hidden">Scan this QR code with your authenticator app:</span>
                    </p>

                    <div class="flex flex-col lg:flex-row gap-8 items-center">
                        <!-- 二维码 -->
                        <div class="flex-shrink-0">
                            <div id="qrcode" class="bg-white p-4 border-2 border-gray-200"></div>
                        </div>

                        <!-- 手动输入选项 -->
                        <div class="flex-1">
                            <p class="text-sm text-gray-600 mb-3">
                                <span class="zh">无法扫描？手动输入密钥：</span>
                                <span class="en hidden">Can't scan? Enter this key manually:</span>
                            </p>
                            <div class="bg-gray-50 p-3 rounded font-mono text-sm break-all">
                                JBSWY3DPEHPK3PXPJBSWY3DPEHPK3PXP
                            </div>
                            <button onclick="copyKey()" class="mt-3 text-sm text-sage-600 hover:text-sage-700 inline-flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <span class="zh">复制密钥</span>
                                <span class="en hidden">Copy Key</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 p-4 rounded-sm mt-6">
                        <p class="text-sm text-amber-800">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span class="zh">重要：请妥善保存密钥，以防手机丢失时恢复访问。</span>
                            <span class="en hidden">Important: Save this key securely for account recovery.</span>
                        </p>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button onclick="goToStep1()" 
                                class="flex-1 py-3 border-2 border-gray-200 text-gray-600 hover:border-gray-300 transition-all">
                            <span class="zh">上一步</span>
                            <span class="en hidden">Previous</span>
                        </button>
                        <button onclick="goToStep3()" 
                                class="flex-1 py-3 bg-sage-600 text-white font-light tracking-wide hover:bg-sage-700 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                            <span class="zh">下一步：验证</span>
                            <span class="en hidden">Next: Verify</span>
                        </button>
                    </div>
                </div>

                <!-- 步骤3：验证设置 -->
                <div id="step3" class="p-8 hidden">
                    <h2 class="text-xl font-light text-gray-800 mb-4">
                        <span class="zh">验证您的设置</span>
                        <span class="en hidden">Verify Your Setup</span>
                    </h2>
                    
                    <p class="text-gray-600 mb-6">
                        <span class="zh">输入您认证应用中显示的6位验证码：</span>
                        <span class="en hidden">Enter the 6-digit code from your authenticator app:</span>
                    </p>

                    <form onsubmit="verifyCode(event)">
                        <!-- 验证码输入 -->
                        <div class="flex gap-2 justify-center mb-6">
                            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl border-2 border-gray-200 focus:border-cambridge-500 focus:outline-none transition-colors" oninput="moveToNext(this, 0)">
                            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl border-2 border-gray-200 focus:border-cambridge-500 focus:outline-none transition-colors" oninput="moveToNext(this, 1)">
                            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl border-2 border-gray-200 focus:border-cambridge-500 focus:outline-none transition-colors" oninput="moveToNext(this, 2)">
                            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl border-2 border-gray-200 focus:border-cambridge-500 focus:outline-none transition-colors" oninput="moveToNext(this, 3)">
                            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl border-2 border-gray-200 focus:border-cambridge-500 focus:outline-none transition-colors" oninput="moveToNext(this, 4)">
                            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl border-2 border-gray-200 focus:border-cambridge-500 focus:outline-none transition-colors" oninput="moveToNext(this, 5)">
                        </div>

                        <!-- 备用恢复码 -->
                        <div class="bg-gray-50 p-6 rounded-sm mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">
                                <span class="zh">备用恢复码（请妥善保存）</span>
                                <span class="en hidden">Backup Recovery Codes (Save Securely)</span>
                            </h3>
                            <div class="grid grid-cols-2 gap-2 font-mono text-sm">
                                <div class="bg-white p-2 border border-gray-200">A2B4-C6D8-E0F2</div>
                                <div class="bg-white p-2 border border-gray-200">G4H6-I8J0-K2L4</div>
                                <div class="bg-white p-2 border border-gray-200">M6N8-O0P2-Q4R6</div>
                                <div class="bg-white p-2 border border-gray-200">S8T0-U2V4-W6X8</div>
                                <div class="bg-white p-2 border border-gray-200">Y0Z2-A4B6-C8D0</div>
                                <div class="bg-white p-2 border border-gray-200">E2F4-G6H8-I0J2</div>
                            </div>
                            <button type="button" onclick="downloadCodes()" class="mt-3 text-sm text-sage-600 hover:text-sage-700 inline-flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="zh">下载恢复码</span>
                                <span class="en hidden">Download Codes</span>
                            </button>
                        </div>

                        <div class="flex gap-4">
                            <button type="button" onclick="goToStep2()" 
                                    class="flex-1 py-3 border-2 border-gray-200 text-gray-600 hover:border-gray-300 transition-all">
                                <span class="zh">上一步</span>
                                <span class="en hidden">Previous</span>
                            </button>
                            <button type="submit"
                                    class="flex-1 py-3 bg-sage-600 text-white font-light tracking-wide hover:bg-sage-700 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                                <span class="zh">启用双因素认证</span>
                                <span class="en hidden">Enable 2FA</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 成功提示 -->
                <div id="success" class="p-8 text-center hidden">
                    <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h2 class="text-2xl font-light text-gray-800 mb-2">
                        <span class="zh">双因素认证已启用</span>
                        <span class="en hidden">2FA Enabled Successfully</span>
                    </h2>
                    <p class="text-gray-500 mb-6">
                        <span class="zh">您的账户现在受到双因素认证保护</span>
                        <span class="en hidden">Your account is now protected with two-factor authentication</span>
                    </p>
                    <button onclick="window.location.href='login-v3-minimal-tcm.html'"
                            class="inline-block py-3 px-8 bg-sage-600 text-white font-light tracking-wide hover:bg-sage-700 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        <span class="zh">完成设置</span>
                        <span class="en hidden">Complete Setup</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 语言状态管理
        let currentLang = 'zh';

        // 切换语言函数
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            
            document.querySelectorAll('.zh').forEach(el => {
                el.style.display = currentLang === 'zh' ? 'inline' : 'none';
            });
            
            document.querySelectorAll('.en').forEach(el => {
                el.style.display = currentLang === 'en' ? 'inline' : 'none';
            });
            
            const toggleText = document.getElementById('lang-toggle-text');
            toggleText.textContent = currentLang === 'zh' ? 'English' : '中文';
            
            document.body.classList.add('fade-in');
            setTimeout(() => {
                document.body.classList.remove('fade-in');
            }, 300);
            
            localStorage.setItem('preferredLanguage', currentLang);
        }

        // 步骤控制
        function goToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            updateStepIndicators(1);
        }

        function goToStep2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            updateStepIndicators(2);
            
            // 生成二维码
            if (!document.getElementById('qrcode').hasChildNodes()) {
                QRCode.toCanvas(document.createElement('canvas'), 'otpauth://totp/TCM%20Platform:user@example.com?secret=JBSWY3DPEHPK3PXPJBSWY3DPEHPK3PXP&issuer=TCM%20Platform', {
                    width: 200,
                    margin: 0
                }, function (error, canvas) {
                    if (!error) {
                        document.getElementById('qrcode').appendChild(canvas);
                    }
                });
            }
        }

        function goToStep3() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            updateStepIndicators(3);
            
            // 聚焦第一个验证码输入框
            setTimeout(() => {
                document.querySelector('#step3 input').focus();
            }, 100);
        }

        function updateStepIndicators(step) {
            const step2Indicator = document.getElementById('step2-indicator');
            const step3Indicator = document.getElementById('step3-indicator');
            
            if (step >= 2) {
                step2Indicator.className = 'w-8 h-8 bg-cambridge-600 text-white rounded-full flex items-center justify-center text-sm font-medium';
                step2Indicator.nextElementSibling.className = 'text-sm font-medium text-gray-700';
            } else {
                step2Indicator.className = 'w-8 h-8 bg-gray-200 text-gray-400 rounded-full flex items-center justify-center text-sm font-medium';
                step2Indicator.nextElementSibling.className = 'text-sm text-gray-400';
            }
            
            if (step >= 3) {
                step3Indicator.className = 'w-8 h-8 bg-cambridge-600 text-white rounded-full flex items-center justify-center text-sm font-medium';
                step3Indicator.nextElementSibling.className = 'text-sm font-medium text-gray-700';
            } else {
                step3Indicator.className = 'w-8 h-8 bg-gray-200 text-gray-400 rounded-full flex items-center justify-center text-sm font-medium';
                step3Indicator.nextElementSibling.className = 'text-sm text-gray-400';
            }
        }

        // 复制密钥
        function copyKey() {
            navigator.clipboard.writeText('JBSWY3DPEHPK3PXPJBSWY3DPEHPK3PXP');
            const message = currentLang === 'zh' ? '密钥已复制到剪贴板' : 'Key copied to clipboard';
            alert(message);
        }

        // 下载恢复码
        function downloadCodes() {
            const codes = `TCM Platform Recovery Codes
==============================
A2B4-C6D8-E0F2
G4H6-I8J0-K2L4
M6N8-O0P2-Q4R6
S8T0-U2V4-W6X8
Y0Z2-A4B6-C8D0
E2F4-G6H8-I0J2
==============================
Keep these codes in a safe place.`;
            
            const blob = new Blob([codes], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tcm-platform-recovery-codes.txt';
            a.click();
        }

        // 验证码输入自动跳转
        function moveToNext(input, index) {
            if (input.value.length === 1) {
                const inputs = document.querySelectorAll('#step3 input[type="text"]');
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            }
        }

        // 验证码验证
        function verifyCode(e) {
            e.preventDefault();
            // 显示成功页面
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('success').classList.remove('hidden');
        }

        // 页面加载时检查语言偏好
        document.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('preferredLanguage');
            if (savedLang && savedLang !== currentLang) {
                toggleLanguage();
            }
        });
    </script>
</body>
</html>