# **DRAFT - FOR REFERENCE ONLY - NOT FOR IMPLEMENTATION**

## 🚨 **FRONTEND SECURITY DISCLAIMER**

**The final authoritative API will be published in `backend/APIdocs/APIv1.md` by the Backend Lead.**

**此文档状态**:
- ❌ **禁止用于实际开发或实现**
- ❌ **数据结构可能变更**
- ❌ **不代表最终API规范**
- ✅ **仅用于前端团队前瞻性UI设计参考**
- ✅ **帮助理解未来API接口结构**

**权威提醒**: 前端开发工作仍然必须等待后端Lead正式发布的 `backend/APIdocs/APIv1.md`。

---

# API v1 草案 - M1.3 处方核心模块

**版本**: 0.1-DRAFT  
**状态**: 讨论草案，非最终版本  
**适用模块**: M1.3 处方核心模块（处方创建与财务计算）  
**依赖**: M1.1 认证基础、M1.2 认证UI集成完成  

---

## ⚠️ 重要声明

**此文档为前瞻性API设计草案，旨在加速后续开发讨论，当前状态：**
- ❌ 未经最终验证
- ❌ 数据结构可能变更  
- ❌ 禁止用于生产开发
- ✅ 用于架构讨论和前端接口预期

---

## 核心API端点概览

### 1. 处方创建 API

#### `POST /v1/prescriptions`

**功能**: 创建新处方并进行财务计算

**请求体 (Request Body)**:
```json
{
  "medicines": [
    {
      "medicineId": "uuid",
      "weight": 15.5,
      "unit": "g",
      "usage": "每日三次，饭后服用"
    }
  ],
  "copies": 3,
  "patientAge": 45,
  "symptoms": "头痛，失眠",
  "notes": "根据患者体质调配"
}
```

**响应体 (Response Body)**:
```json
{
  "prescriptionId": "uuid",
  "status": "DRAFT",
  "totalAmount": 15750,
  "breakdown": {
    "medicinesCost": 12500,
    "serviceFee": 2500,
    "gst": 750,
    "platformFee": 625
  },
  "qrCode": {
    "url": "https://storage.supabase.io/...",
    "expiresAt": "2025-08-25T10:30:00Z"
  },
  "createdAt": "2025-08-22T10:30:00Z"
}
```

### 2. 处方计算 API

#### `POST /v1/prescriptions/calculate`

**功能**: 仅进行价格计算，不创建处方

**请求体**:
```json
{
  "medicines": [
    {
      "medicineId": "uuid",
      "weight": 15.5
    }
  ],
  "copies": 3
}
```

**响应体**:
```json
{
  "totalAmount": 15750,
  "breakdown": {
    "medicinesCost": 12500,
    "serviceFee": 2500,
    "gst": 750,
    "platformFee": 625
  },
  "calculatedAt": "2025-08-22T10:30:00Z"
}
```

### 3. 处方状态更新 API

#### `PATCH /v1/prescriptions/{prescriptionId}/status`

**功能**: 更新处方状态（支付、履约等）

**请求体**:
```json
{
  "status": "PAID",
  "paymentMethod": "stripe",
  "transactionId": "pi_xxxxx"
}
```

**响应体**:
```json
{
  "prescriptionId": "uuid",
  "status": "PAID",
  "updatedAt": "2025-08-22T10:35:00Z",
  "qrCode": {
    "url": "https://storage.supabase.io/...",
    "expiresAt": "2025-08-25T10:35:00Z"
  }
}
```

---

## 数据结构定义

### 处方状态枚举
```typescript
type PrescriptionStatus = 
  | "DRAFT"      // 草稿状态
  | "PAID"       // 已支付
  | "PENDING_REVIEW"  // 待审核
  | "FULFILLED"  // 已履约
  | "SETTLED"    // 已结算
  | "CANCELLED"  // 已取消
  | "EXPIRED";   // 已过期
```

### 金额计算字段
- **单位**: 所有金额以NZD cents存储 (INTEGER)
- **精度**: 银行家舍入算法
- **计算**: 使用Decimal.js避免浮点误差

---

## 核心错误码定义

### 业务错误

| 错误码 | HTTP状态 | 描述 | 处理建议 |
|--------|----------|------|----------|
| `MEDICINE_NOT_FOUND` | 404 | 药品ID不存在 | 检查药品库存，更新药品清单 |
| `INSUFFICIENT_BALANCE` | 402 | 账户余额不足 | 提示用户充值或选择其他支付方式 |
| `INVALID_WEIGHT` | 400 | 药品重量超出允许范围 | 检查重量限制，提供合理范围提示 |
| `PRESCRIPTION_EXPIRED` | 410 | 处方已过期 | 重新创建处方 |
| `CONCURRENT_UPDATE` | 409 | 并发更新冲突 | 重新获取最新状态并重试 |

### 系统错误

| 错误码 | HTTP状态 | 描述 | 处理建议 |
|--------|----------|------|----------|
| `CALCULATION_ERROR` | 500 | 价格计算引擎错误 | 稍后重试，联系技术支持 |
| `QR_GENERATION_FAILED` | 500 | QR码生成失败 | 重试或联系技术支持 |
| `DATABASE_ERROR` | 500 | 数据库操作失败 | 稍后重试 |

---

## 安全与审计要求

### 认证要求
- **Header**: `Authorization: Bearer <jwt_token>`
- **角色**: 仅限 `practitioner` 角色访问
- **RLS**: 通过Supabase RLS策略确保数据隔离

### 审计日志
所有处方操作将记录以下信息：
```json
{
  "action": "CREATE_PRESCRIPTION",
  "userId": "uuid",
  "prescriptionId": "uuid", 
  "ipAddress": "xxx.xxx.xxx.xxx",
  "userAgent": "...",
  "timestamp": "2025-08-22T10:30:00Z",
  "metadata": {
    "totalAmount": 15750,
    "medicineCount": 5
  }
}
```

### 数据保护
- **患者匿名化**: 不存储患者个人身份信息
- **处方加密**: 敏感字段使用AES-256加密
- **访问控制**: 严格的RLS策略和权限验证

---

## 性能与限制

### API限制
- **请求频率**: 100次/分钟 per 用户
- **处方大小**: 最多20种药材 per 处方
- **重量限制**: 单味药材 1g-100g
- **备注长度**: 最多500字符

### 性能目标
- **响应时间**: P95 < 200ms (计算API)
- **创建处方**: P95 < 500ms (包含QR码生成)
- **并发处理**: 支持100并发用户

---

## 依赖服务

### Edge Functions
- `prescription-calculator`: 财务计算引擎
- `qr-generator`: QR码生成服务  
- `audit-logger`: 审计日志记录

### Supabase 服务
- **Database**: 处方数据持久化
- **Auth**: 用户认证与授权
- **Storage**: QR码图片存储
- **RLS**: 数据访问控制

---

## 示例工作流

### 典型处方创建流程
```
1. 前端调用 POST /v1/prescriptions/calculate 预览价格
2. 用户确认后调用 POST /v1/prescriptions 创建处方  
3. 系统返回处方ID和QR码URL
4. 前端引导用户完成支付
5. 支付成功后调用 PATCH status API更新为PAID
6. 系统生成最终QR码供患者使用
```

---

## 🎯 **前端团队使用建议**

### ✅ **可以做的**:
- 基于API结构设计UI组件接口
- 规划处方创建页面的表单结构
- 设计价格显示和计算预览组件
- 准备错误处理和状态管理逻辑
- 规划QR码显示和状态流转UI

### ❌ **不能做的**:
- 开始实际的API集成开发
- 基于此文档编写生产代码
- 假设最终API与此完全一致
- 跳过等待正式API规范发布

---

# **DRAFT - FOR REFERENCE ONLY - NOT FOR IMPLEMENTATION**

**提醒**: 此文档来源于首席架构师的前瞻性设计，仅用于前端团队的UI规划参考。实际开发必须等待后端Lead正式发布的权威API规范。

**来源**: 首席全栈架构师  
**分发时间**: 2025-08-22  
**权威API位置**: `backend/APIdocs/APIv1.md` (待后端Lead发布)