name: Documentation Guard

on:
  pull_request:
    branches: [docs-main]
    paths:
      - 'CLAUDE.md'
      - 'INITIAL.md'
      - 'PLANNING.md'
      - 'FRONTEND_PLAYBOOK.md'
      - 'LEGACY_ASSETS_INVENTORY.md'
      - 'examples/**'

jobs:
  protect-governance-docs:
    name: Governance Document Protection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for protected file changes
        run: |
          echo "üîç Checking for changes to protected governance documents..."
          
          CHANGED_FILES=$(git diff --name-only origin/docs-main..HEAD)
          PROTECTED_FILES=""
          
          for file in $CHANGED_FILES; do
            case $file in
              CLAUDE.md|INITIAL.md|PLANNING.md|FRONTEND_PLAYBOOK.md|LEGACY_ASSETS_INVENTORY.md|examples/*)
                PROTECTED_FILES="$PROTECTED_FILES $file"
                ;;
            esac
          done
          
          if [ -n "$PROTECTED_FILES" ]; then
            echo "‚ö†Ô∏è Protected governance documents are being modified:"
            echo "$PROTECTED_FILES"
            echo "üìã This PR requires approval from CODEOWNERS"
            echo "üîí Governance document changes require explicit authorization"
          else
            echo "‚úÖ No protected governance documents modified"
          fi
          
      - name: Validate document structure
        run: |
          echo "üìä Validating document structure..."
          
          # Check for required sections in key documents
          if [ -f "CLAUDE.md" ]; then
            if ! grep -q "## üö® Critical \"Do NOT\" Rules" CLAUDE.md; then
              echo "‚ùå CLAUDE.md missing required 'Do NOT Rules' section"
              exit 1
            fi
          fi
          
          if [ -f "INITIAL.md" ]; then
            if ! grep -q "## üìä Progress Tracker" INITIAL.md; then
              echo "‚ùå INITIAL.md missing required 'Progress Tracker' section"
              exit 1
            fi
          fi
          
          echo "‚úÖ Document structure validation passed"